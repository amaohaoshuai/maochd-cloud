var e=Object.defineProperty,i=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,n=(i,t,a)=>t in i?e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[t]=a,o=(e,i)=>{for(var t in i||(i={}))l.call(i,t)&&n(e,t,i[t]);if(a)for(var t of a(i))s.call(i,t)&&n(e,t,i[t]);return e},r=(e,a)=>i(e,t(a));import{_ as d}from"./SubmitButton.99d990fd.js";import{_ as u}from"./EditForm.8c35f1a6.js";import{_ as p}from"./BaseTable.36f55649.js";import{_ as c}from"./SelectTable.80e1f2f6.js";import{_ as m}from"./KeyBoard.96ba8d0b.js";import{_ as f}from"./BaseForm.bc55ad6b.js";import{_ as g}from"./BaseCard.46de0c24.js";import{_ as b}from"./BaseName.1aa32b4b.js";import{_ as h}from"./InputDate.1acc5e94.js";import{b as y}from"./vue-router.91336ba9.js";import{f as v,a as x,b as N,c as k,e as w,h as D,i as C,j as T,s as U,k as P}from"./index.2b658791.js";import{u as S}from"./vuex.c868d4e0.js";import{k as j,s as z}from"./index.1eb722f1.js";import{_ as E}from"./lodash.d7ab6f48.js";import{b as _,_ as B}from"./element-plus.b44d97a8.js";import{h as R}from"./moment.08a7f518.js";import{f as F,t as A}from"./filter.c2c8f0b9.js";import{a as q}from"./businessRule.60794e55.js";import{j as L,e as O,S as I,B as V,Y as M,h as Y,D as $,t as G,q as H,L as W,J as K,o as J,c as Q,w as X,a5 as Z,v as ee,a6 as ie,z as te,O as ae,N as le,a8 as se,ab as ne,F as oe,a9 as re,aa as de}from"./@vue.23a4bd1a.js";import{_ as ue}from"./index.ab904951.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";var pe={name:"AddPurchaseDispatch",setup(){let e=y(),i=S(),{dict:t,info:a}=i.state.common,l=L({insufficientPrompt:[{batchNumber:"",drugUuid:""}],processStatus:"process",stepsContent:[{title:"采购收货",description:"成功",active:1},{title:"采购验收",description:"",active:2},{title:"采购入库",description:"",active:3}],active:1,people:[],supplier:[],mechanism:[],selectArr:[],isEdit:!1,isDetail:!1,keys:["code","name","dosageForm","specification","manufacturer"],transportationMode:t.find((e=>"transportationMode"===e.key)).data,transportMeans:t.find((e=>"transportMeans"===e.key)).data,temperControlEquip:t.find((e=>"temperControlEquip"===e.key)).data,refuseReason:t.find((e=>"refuseReason"===e.key)).data}),s=L({isRefuseReason:!1,supplierDisabled:!1,isFlag:!0,isDisabled:!1,oldBusiness:[],oldSupplierName:[],oldSupplierUuid:[],mnemonic:"",selectLoading:!1,selectTable:null,dialogVisible:!1,dialogGoodsName:"",dialogGoodsDetail:"",businessScope:[],isExpires:!1,expiresCredential:"",taxPaid:"",formData3:{span:10,labelWidth:"90px",list:[{label:"备注",type:"INPUT",key:"remark",inputType:"textarea",span:8,design:{width:"100%"},config:{showWordLimit:!1,maxlength:100,autosize:{minRows:1,maxRows:1}},disabled:()=>l.isDetail},{key:"receiveNo",type:"TEMP",span:16,design:{width:"100%"},render:({receiveNo:e,user:i,orderNo:t,createUser:a})=>O("div",{style:"padding-left:156px;"},[I("收货单编号："),e||"-"," ",I("     创建人："),i||"-"," ",I("     采购单编号："),t||"-"," ",I("     采购员："),a||s.createUser])}]},pagination:{page:1,size:10,total:100},baseNameList:["name","specification","unit","manufacturer"],count:0,successNum:0,loading:!1,tList:[],fileList:[],upSet:!0,suppName:"",index:0,disabled:!1,showIcon:!1,editForm:null,editForm1:null,baseTable:null,keyBoard:null,selectParams:{orderUuid:"",fuzzyValue:""},title:"请选择采购单",visibility:!1,visibility1:!1,close:!1,go:{path:"/purchase/purchase-dispatch"},text:"新增",pot:-1,batchNumberDuplicatList:[],cacheNumber:{},query:{},formData:{labelWidth:"90px",span:6,list:[{label:"运输方式",require:!0,type:"SELECT",key:"transportMode",list:()=>l.transportationMode,props:{label:"key",value:"key"},disabled:()=>l.isDetail},{label:"运输工具",require:!0,key:"transportMeans",type:"SELECT",list:()=>l.transportMeans,props:{label:"key",value:"key"},disabled:()=>l.isDetail},{label:"温控设备",require:!0,type:"SELECT",list:()=>l.temperControlEquip,key:"temperControlEquip",props:{label:"key",value:"key"},disabled:()=>l.isDetail},{label:"启运温度",require:!0,type:"INPUT",key:"temperShip",suffix:{tempHtml:()=>O("span",{style:"height: 40px; width: 25px; text-align: center"},[I("℃")])},disabled:()=>l.isDetail},{label:"到达温度",require:!0,type:"INPUT",key:"arriveTemper",suffix:{tempHtml:()=>O("span",{style:"height: 40px; disg width: 25px; text-align: center"},[I("℃")])},disabled:()=>l.isDetail},{label:"启运时间",require:!0,type:"DATEPICKER",key:"shipTime",config:{valueFormat:"YYYY-MM-DD HH:mm:ss",type:"datetime",disabledDate:e=>{let i=s.info.arriveTime;return!!i&&e.getTime()>new Date(i).getTime()}},disabled:()=>l.isDetail},{label:"到达时间",require:!0,type:"DATEPICKER",disabled:()=>l.isDetail,key:"arriveTime",config:{valueFormat:"YYYY-MM-DD HH:mm:ss",type:"datetime",disabledDate:e=>{let i=s.info.shipTime;return!!i&&e.getTime()<new Date(i).getTime()+864e5}}}]},formInfo:{labelWidth:"90px",span:6,list:[{label:"开票日期",require:!0,type:"DATEPICKER",key:"invoiceTime",config:{valueFormat:"YYYY-MM-DD"},disabled:()=>l.isDetail},{label:"供应商名称",require:!0,type:"SELECT",props:{label:"supplierName",value:"supplierUuid"},render:e=>0==s.isExpires?"":O(V("el-tooltip"),{class:"item",effect:"dark",content:s.expiresCredential,placement:"top-start"},{default:()=>[O("i",{class:"el-icon-warning",style:"color:rgb(245, 108, 108);position: absolute;left: 165px;top: 50%; transform: translateY(-50%);"},null)]}),config:{filterable:!0,filterMethod:e=>te(e),onChange:e=>{let i=E.find(l.supplier,{supplierUuid:e});s.expiresCredential=i.expiresCredential,s.isExpires=i.isExpires,s.info.supplierName=i.supplierName,s.supplierName=i.supplierName,s.businessScope=i.basicInfo.businessScope,"期初导入"==i.supplierName&&(s.upSet=!1)}},list:()=>l.supplier,key:"supplierUuid",disabled:()=>l.isDetail||s.supplierDisabled},{label:"门店",require:!0,type:"SELECT",props:{label:"name",value:"uuid"},config:{onChange:e=>{let i=E.find(l.mechanism,{uuid:e});s.info.business=i.name,0==s.data.length&&(s.oldBusiness=s.info.businessUuid),X(),s.isDisabled=!1,s.data.length>0&&_.confirm("切换当前门店会清空数据!","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{s.data=[],s.oldBusiness=s.info.businessUuid,s.info.orderNo="",s.info.receiveNo="",s.createUser="",s.isDisabled=!1,s.supplierDisabled=!1,X()})).catch((()=>{s.info.businessUuid&&(s.info.businessUuid=s.oldBusiness),s.isDisabled=!0}))},disabled:!0},list:()=>l.mechanism,key:"businessUuid",disabled:()=>l.isDetail},{label:"随货同行单",type:"INPUT",key:"peer",disabled:()=>l.isDetail}]},info:{user:i.state.common.info.userName,storeName:a.storeName},cacheItems:[],columns:[{title:"序号",type:"index",fixed:"left",formConfig:{width:50}},{title:"商品编码",key:"code",width:105,fixed:"left",render:e=>{let i=!s.businessScope.length||s.businessScope.includes(e.category1);return O("div",{style:{color:i?"":"rgb(245, 108, 108)"}},[e.code,I(" "),i?"":O(V("el-tooltip"),{class:"item",effect:"dark",content:"该商品不在该供应商的经营范围",placement:"top-start"},{default:()=>[O("i",{class:"el-icon-warning",color:"rgb(245,108,108)",size:"small"},null)]})])}},{title:"商品名称/规格/单位/生产厂家",width:240,fixed:"left",render:e=>O(b,{row:e,list:s.baseNameList},null)},{title:"批号",require:!0,header:()=>O("div",{class:"table-title"},[O("i",null,[I("*")]),I("批号")]),key:"batchNumber",width:180,render:(e,i,t,a)=>O(V("el-input"),{class:e[`batchNumber_${a}`],modelValue:e.batchNumber,size:"mini",type:"text",disabled:l.isDetail,onInput:i=>{W(e,"batchNumber",i)},onChange:i=>{W(e,"batchNumber",i)},placeholder:"请输入内容",clearable:!0},null)},{title:"生产日期",keyWord:"productionDate",width:140,render:(e,i,t,a)=>O(h,{class:e[`productionDate_${a}`],data:e,text:"productionDate",disabled:l.isDetail,onChange:i=>{!i||F(i)>=F((new Date).getTime())?e.productionDate=i:(e.productionDate=i,s.expireDate=i)}},null)},{title:"有效期至",require:!0,header:()=>O("div",{class:"table-title"},[O("i",null,[I("*")]),I("有效期至")]),keyWord:"expireDate",width:140,render:(i,t,a,s)=>{const n=(new Date).getTime(),o=(new Date(i.expireDate)-n)/1e3/3600/24;let r="";return r=e.query.isEdit?o>=0&&o<=180?"waring":o<0?"error":"":"",O(h,{class:i[`expireDate_${s}`],slots:()=>u(i),data:i,isStyle:"waring"==r,text:"expireDate",disabled:l.isDetail,onChange:e=>{!e||(F(e),F((new Date).getTime())),i.expireDate=e}},null)}},{title:"本次收货数量",require:!0,rule:[0],header:()=>O("div",{class:"table-title"},[O("i",null,[I("*")]),I("本次收货数量")]),key:"receiveNum",width:120,render:(e,i,t,a)=>{let s=E.find(l.insufficientPrompt,{batchNumber:e.batchNumber}),n=E.find(l.insufficientPrompt,{drugUuid:e.drugUuid});return s&&n?O("div",{style:"position: absolute;"},[O(V("el-input-number"),{size:"mini",class:e[`receiveNum_${a}`],style:"top:-15px;left:-5px;",stepStrictly:!0,disabled:l.isDetail,min:-999999.999999,max:999999.999999,placeholder:"请输入",modelValue:e.receiveNum,onChange:i=>{W(e,"receiveNum",i),f(e,"receiveNum",!0),setTimeout((()=>{0===i&&W(e,"receiveNum",void 0),e.receiveNum=i}))}},null),O(V("el-tooltip"),{effect:"dark",content:"批号数量库存不足",placement:"top-start",class:"insufficient"},{default:()=>[O("div",null,[O("i",{className:"el-icon-warning",style:"color:rgb(245, 108, 108);margin-right: 10px;"},null)])]})]):O(V("el-input-number"),{size:"mini",class:e[`receiveNum_${a}`],stepStrictly:!0,disabled:l.isDetail,min:-999999.999999,max:999999.999999,placeholder:"请输入",modelValue:e.receiveNum,onChange:i=>{W(e,"receiveNum",i),f(e,"receiveNum",!0),setTimeout((()=>{0===i&&W(e,"receiveNum",void 0),e.receiveNum=i}))}},null)}},{title:"含税进价",require:!0,rule:[0],header:()=>O("div",{class:"table-title"},[O("i",null,[I("*")]),I("含税进价")]),key:"taxPaid",width:120,align:"right",render:(e,i,t,a)=>{let s="";return s=l.isDetail?e.diffAmount>0?O("i",{class:"el-icon-top",style:"position: absolute; right: 10px; top: 8px; color: red; font-weight: 700;"},null):e.diffAmount<0?O("i",{class:"el-icon-bottom",style:"position: absolute; right: 10px; top: 8px; color: green; font-weight: 700;"},null):"":e.taxPaid>e.lastTaxPaid?O("i",{class:"el-icon-top",style:"position: absolute; right: 10px; top: 8px; color: red; font-weight: 700;"},null):e.taxPaid<e.lastTaxPaid?O("i",{class:"el-icon-bottom",style:"position: absolute; right: 10px; top: 8px; color: green; font-weight: 700;"},null):"",O("div",{style:"position: relative"},[O(V("el-input-number"),{size:"mini",placeholder:"请输入",step:1e-6,stepStrictly:!0,disabled:l.isDetail,class:e[`taxPaid_${a}`],min:1e-6,max:99999999,modelValue:e.taxPaid||void 0,onChange:i=>{W(e,"taxPaid",i),setTimeout((()=>{0!==i&&-1===i.toString().indexOf("-")||W(e,"taxPaid",void 0)}))}},null),s])}},{title:"含税金额",key:"taxAmount",width:80,align:"right",render:e=>{let{receiveNum:i,taxPaid:t}=e;return e.taxAmount=i&&t?(i*t).toFixed(2):0,O("div",{style:""},[e.taxAmount])}},{title:"进价",key:"price",width:80,align:"right",render:e=>{let{taxPaid:i,inputTaxRate:t}=e;return O("div",null,[i?i/(1+(t?t/100:0)):""])}},{title:"金额",key:"amount",width:80,align:"right",render:e=>{let{taxPaid:i,inputTaxRate:t,receiveNum:a}=e,l=i?i/(1+(t?t/100:0)):"";return e.amount=l?l*a:"",O("div",null,[e.amount?e.amount.toFixed(2):"-"])}},{title:"差额",key:"diffAmount",width:80,align:"right",header:()=>O(V("el-tooltip"),{class:"item",effect:"dark",content:"=此次含税进价-上次含税进价",placement:"top"},{default:()=>[O("span",null,[I("差额"),O("i",{className:"el-icon-warning"},null)])]}),render:e=>(!0===l.isDetail?!e.diffAmount||e.diffAmount:e.diffAmount=e.taxPaid?e.taxPaid-e.lastTaxPaid:0-e.lastTaxPaid,e.diffAmount>0?O("div",{style:"color:red"},[e.diffAmount]):e.diffAmount<0?O("div",{style:"color:green"},[e.diffAmount]):O("div",null,[e.diffAmount]))},{title:"零售价",key:"retailPrice",width:80,align:"right",render:e=>O("div",null,[e.retailPrice?e.retailPrice:""])},{title:"零售金额",key:"retailAmount",width:80,align:"right",render:e=>{let{retailPrice:i,receiveNum:t}=e;return e.retailAmount=t&&i?t*i:"",O("div",null,[A(e.retailAmount)])}},{title:"进项税率",key:"inputTaxRate",width:100,render:e=>O(V("el-input-number"),{modelValue:0===e.inputTaxRate||e.inputTaxRate?e.inputTaxRate:void 0,min:0,step:1,disabled:l.isDetail,stepStrictly:!0,max:100,size:"mini",placeholder:"请输入",onChange:i=>{W(e,"inputTaxRate",i)}},null)},{title:"税额",key:"tax",width:80,align:"right",render:e=>{let{taxPaid:i,inputTaxRate:t,receiveNum:a,taxAmount:l}=e,s=i?i/(1+(t?t/100:0)):"";s=s?s*a:"";let n=a&&i?a*i:0;return e.tax=n-s||0,O("div",null,[e.tax])}},{title:"订单数量/未收",width:230,align:"right",render:e=>{let{purchaseNum:i,outStandNum:t,receiveNum:a}=e;return i||t?i+"/"+(1e6*Number(i)-1e6*Number(a))/1e6:"-"}},{title:"拒收数量",require:!0,key:"returnNum",width:150,render:e=>O(V("el-input-number"),{size:"mini",modelValue:e.returnNum||void 0,min:0,step:1e-6,disabled:l.isDetail||e.receiveNum<0,stepStrictly:!0,placeholder:"请输入",onChange:i=>{W(e,"returnNum",i),f(e,"returnNum",!1),e.returnNum||(e.refuseReason="")},onBlur:i=>{n(e)}},null)},{title:"拒收原因",key:"refuseReason",width:150,render:(i,t,a,s)=>{let o;return O(V("el-select"),{disabled:!i.returnNum||e.query.uuid||l.isDetail,size:"mini",class:i[`refuseReason_${s}`],modelValue:i.refuseReason,placeholder:"请选择",onChange:e=>{W(i,"refuseReason",e),n(i)}},"function"==typeof(r=o=l.refuseReason.map((e=>O(V("el-option"),{key:e.key,label:e.key,value:e.key},null))))||"[object Object]"===Object.prototype.toString.call(r)&&!M(r)?o:{default:()=>[o]});var r}},{title:"中药饮片产地",key:"medicineBeverage",width:150,render:e=>O(V("el-input"),{size:"mini",disabled:l.isDetail,modelValue:e.medicineBeverage,onInput:i=>{W(e,"medicineBeverage",i)},placeholder:"请输入"},null)},{title:"批准文号",key:"approvalNumber",width:160},{title:"上市许可持有人",key:"holderPermit",width:165},{title:"操作",key:"options",width:60,render:(e,i,t,a)=>O(V("el-button"),{type:"text",class:"delete",onClick:()=>{ee(a)}},{default:()=>[I("删除")]})}],data:[],dialog:{columns:[{title:"序号",type:"index",formConfig:{width:50}},{title:"采购单编号",key:"orderNo"},{title:"计划单编号",key:"planNo"},{title:"采购员",key:"createUser"},{title:"供应商名称",key:"supplierName"},{title:"含税金额合计",key:"totalAmountTax"},{title:"门店",key:"business"}],columns1:[{type:"selection",width:55,align:"center"},{title:"序号",type:"index",formConfig:{width:50}},{title:"商品编码",width:"100",key:"code"},{title:"商品名称",key:"name",width:180},{title:"商品类别",width:"105",key:"category1"},{title:"剂型",key:"dosageForm"},{title:"规格",key:"specification"},{title:"单位",key:"unit"},{title:"订单数量(剩余未收)",width:150,render:e=>O("div",null,[e.purchaseNum||e.purchaseNum.toFixed(6),I("("),e.outStandNum||e.outStandNum.toFixed(6),I(")")])},{title:"生产厂家",key:"manufacturer"},{title:"产地",key:"origin"},{title:"批准文号",key:"approvalNumber"},{title:"上市许可持有人",key:"holderPermit",width:150}],items:[],data:[{},{}],data1:[],info:{},info1:{"page.pageSize":10,"page.currentPage":1},formData:{inline:!0,labelWidth:"90px",list:[{label:"供应商名称",type:"SELECT",props:{label:"supplierName",value:"supplierName"},config:{onChange:e=>{}},list:()=>l.supplier,key:"supplierName"},{label:"采购单编号",key:"orderNo",type:"INPUT"},{label:"门店",require:!0,type:"SELECT",disabled:()=>!0,props:{label:"name",value:"uuid"},config:{onChange:e=>{let i=E.find(l.mechanism,{uuid:e});s.info.business=i.name}},list:()=>l.mechanism,key:"businessUuid"}]}}});const n=e=>{e.returnNum&&!e.refuseReason?s.isRefuseReason=!0:s.isRefuseReason=!1},d=e=>{if(2!==e.purchaseState){E.find(s.data,{code:e.code})&&(e.receiveNum=void 0);let i=E.cloneDeep(e);i.taxPaid=i.lastTaxPaid,i.receiveNum=i.receiveNum||void 0,s.data.push(E.cloneDeep(i)),s.pagination.page=Math.ceil(s.data.length/s.pagination.size);let t=s.data.length%s.pagination.size;s.pot=t?t-1:s.pagination.size-1,l.selectArr=[]}else s.dialogGoodsDetail=e.specification+"/"+e.unit+"/"+e.manufacturer,s.dialogGoodsName=e.name,s.dialogVisible=!0;s.selectTable.ending(),l.selectArr=[]},u=e=>{const i=(new Date).getTime(),t=(new Date(e.expireDate)-i)/1e3/3600/24;let a=t>=0&&t<=180?"waring":t<0?"error":"";return e.expireDate?"error"==a?O(V("el-tooltip"),{effect:"dark",content:"过期商品不允许保存",placement:"top-start"},{default:()=>[O("div",null,[O("i",{className:"el-icon-warning",style:"color:rgb(245, 108, 108);margin-right: 10px;"},null)])]}):void 0:O("div",null,null)},p=async e=>{try{await P(e.tdata),l.active=3,l.stepsContent[2].description="成功",setTimeout((()=>{s.visibility1=!1,s.close=!0}),1e3)}catch(i){return l.stepsContent[2].description="失败",setTimeout((()=>{s.visibility1=!1,_.confirm("采购入库失败，请手动入库","提示",{confirmButtonText:"我知道了",type:"error",showCancelButton:!1,closeOnClickModal:!1,closeOnPressEscape:!1}).then((()=>{s.close=!0}))}),2500),i}},c=async(e,i)=>{if(!m.value){s.formData.list.map((e=>e.key)).forEach((i=>{e[i]=null}))}let t=s.query.uuid?C:T;1==l.mechanism.length&&(e.business=l.mechanism[0].name);let n=await t({info:e,details:i});if(0===n.diffDateList.length){if(0===n.sameTaxPaidList.length)return 0!==n.unStockList.length?(n.unStockList.map(((e,i)=>{let t={};t.batchNumber=e.split(":")[0],t.drugUuid=e.split(":")[1],l.insufficientPrompt.push(t)})),void l.insufficientPrompt.splice(0,1)):void setTimeout((async()=>{"1"==a.oneClickStorageConfig?_.confirm("是否选择一键入库！","提示",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then((async()=>{s.visibility1=!0,await(async e=>{try{const i=await U(e);l.active=2,l.stepsContent[1].description="成功",await p(i)}catch(i){return l.stepsContent[1].description="失败",setTimeout((()=>{s.visibility1=!1,_.confirm("采购验收失败，请手动验收","提示",{confirmButtonText:"我知道了",type:"error",showCancelButton:!1,closeOnClickModal:!1,closeOnPressEscape:!1}).then((()=>{s.close=!0})).catch((()=>{s.close=!0}))}),2500),i}})(n.receiveUuid)})).catch((e=>{s.close=!0})):s.close=!0}),200);B.error("同商品同批号同有效期同进价时不允许提交！")}else B.error("商品批号相同时有效期/生产日期不同不允许提交！")},m=Y((()=>!!s.data.find((e=>e.coldChain)))),f=(e,i,t)=>{let a=s.data.filter((i=>i.code===e.code?i:null)),{code:l,outStandNum:n}=a[0],o=0;a.forEach((e=>{let{receiveNum:i,returnNum:t}=e;o=o+(Number(i)||0)+(Number(t)||0)})),null!=n&&o>n&&_.alert("收货数量和拒收数量合计不能大于该商品的剩余未收数量",{confirmButtonText:"我知道了",callback:a=>{if(e[i]=void 0,t){let{array:e,index:i}=s.keyBoard;s.keyBoard.index--,e[s.keyBoard.index].focus()}}})},g=Y((()=>{let e={code:E.uniqBy(s.data,"code").length,receiveNum:0,taxAmount:0,amount:0,tax:0};return s.data.forEach((i=>{let{receiveNum:t,amount:a,tax:l,taxPaid:s,inputTaxRate:n}=i,o=s?s/(1+(n?n/100:0)):"",r=0;r=o?o*t:"";let d=t&&s?t*s:0;e.receiveNum+=parseFloat(t||0,10);let u=t&&s?t*s:0;e.taxAmount=(100*e.taxAmount+100*u)/100,e.amount+=parseFloat(o?o*t:0)||0,e.tax+=parseFloat(d-r||0,10)})),e})),W=(e,i,t)=>{e[i]="batchNumber"===i?t.trim():t},K=async()=>{let e=await k(s.dialog.info1),{list:i,totalCount:t}=e||{list:[],totalCount:0};s.dialog.info1.total=t,s.dialog.data1=i},J=()=>{s.itemCache={},s.dialog.items=[],--s.index,s.title="请选择采购单"},Q=async e=>{let{info:i,details:t}=await w(e);s.info=i,s.data=t,s.selectParams.orderUuid=i.orderUuid},X=async()=>{1==l.mechanism.length&&(s.oldBusiness=l.mechanism),l.people=await i.dispatch("common/selectByStation",{stationName:2,businessUuid:s.oldBusiness}),l.createUserName=l.people,l.people.length>0?(s.createUser=l.people[0].userName,s.info.createUser=l.people[0].userName):(s.createUser="",s.info.createUser="")};$((async()=>{l.selectArr=[],l.isEdit=e.query.isEdit,l.isDetail=e.query.isDetail,"true"==l.isDetail?l.isDetail=!0:l.isDetail=!1,l.isDetail&&s.columns.splice(s.columns.splice.length-1,1);let{query:t}=e;s.text=t.uuid?"编辑":"新增",s.query.uuid!==t.uuid&&(t.uuid?(s.disabled=!0,await Q(t.uuid)):(s.disabled=!1,s.info={},s.data=[],s.selectParams.orderUuid=""),s.query=E.cloneDeep(t)),s.oldBusiness=s.info.businessUuid,l.mechanism.length||(l.mechanism=await i.dispatch("common/mechanism"),q(s.info,l.mechanism),1===l.mechanism.length&&(s.oldBusiness=l.mechanism[0].uuid),l.people=await i.dispatch("common/selectByStation",{stationName:2,businessUuid:s.oldBusiness}),l.supplier=await z(),l.supplier.length>0&&(s.supplierName=l.supplier[0].supplierName),l.createUserName=l.people,ie(),l.people.length>0&&(s.createUser=l.people[0].userName,s.info.createUser=l.people[0].userName,s.createUser=l.createUserName[0].userName)),s.createUser=s.info.createUser,s.info.createUser=s.info.createUser}));const Z=()=>{s.batchNumberDuplicatList.length&&(s.baseTable.verification(),s.data.slice((s.pagination.page-1)*s.pagination.size,(s.pagination.page-1)*s.pagination.size+s.pagination.size).map(((e,i)=>{s.batchNumberDuplicatList.map((t=>{e.code==t.code&&e.batchNumber==t.batchNumber&&H((()=>{e[`batchNumber_${i}`]="error"}))}))})))},ee=e=>{if(!l.isEdit)return;let i=s.pagination.page-1;i=i*s.pagination.size+e,s.data.splice(i,1),s.pot=e,Z()},ie=async()=>{l.supplier=await j({mnemonic:s.mnemonic}),s.supplierName=l.supplier[0].supplierName},te=e=>{s.mnemonic=e,ie()},ae=()=>{_.confirm("请选择门店后,再进行操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{s.isFlag=!0})).catch((()=>{s.isFlag=!0}))};return r(o(o({},G(s)),G(l)),{getDetail:Q,handleInput:async(e,i)=>{if(s.isFlag){if(!s.info.businessUuid)return void ae();let{selectParams:i}=s;i.fuzzyValue=e;let t=o({businessUuid:s.info.businessUuid},i),a=await v(t);1===a.length?d(a[0]):(l.selectArr=a,s.selectLoading=!1),s.info.businessUuid||(s.isFlag=!1)}},handleChange:d,handleSubmit:async e=>{if(!s.info.businessUuid)return void ae();if(s.isRefuseReason)return void B.error("请选择拒收原因！");let{info:i,data:t,editForm:a,editForm1:n,baseTable:o}=s;if(0==l.mechanism.length)return void B.error("请配置门店！");if(0==l.createUserName.length)return void B.error("请配置采购员！");s.info.createUser=l.createUserName[0].userName;let r=!0,d=!1,u=!1;const p=(new Date).getTime();return r=a.handleClick(e),n&&(r=n.handleClick(e)),t.length?(t.length&&(r=o.verification()),!!r&&(t.forEach(((e,i)=>{let{returnNum:t,refuseReason:a}=e;t&&!a?(r=!1,e[`refuseReason_${i}`]="error"):e[`refuseReason_${i}`]="",R(e.expireDate).diff(R(new Date,"YYYY-MM-DD"),"days")<=180&&(d=!0),(new Date(e.expireDate)-p)/1e3/3600/24<0&&(u=!0)})),void(u?B.error("过期商品不允许保存"):s.info.invoiceTime&&(d?_.confirm("存在近效期商品，是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{c(i,t)})):c(i,t))))):(B.warning({message:"请添加商品信息",type:"warning"}),!1)},coldChain:m,handleGetOrder:async e=>{s.info.businessUuid?(1===e&&(s.dialog.info.businessUuid=s.info.businessUuid,s.dialog.info.supplierName=s.info.supplierName,s.dialog.info.supplierUuid=s.info.supplierUuid,s.oldSupplierName=s.info.supplierName,s.oldSupplierUuid=s.info.supplierUuid),s.dialog.data=await x(s.dialog.info),s.visibility||(s.index=0,s.visibility=!0)):ae()},handleTableClick:async({item:e,type:i})=>{s.itemCache=r(o({},e),{orderUuid:e.uuid}),"dblclick"===i&&(s.info.createUser=e.createUser,s.dialog.info1=r(o({},s.dialog.info1),{orderUuid:e.uuid}),await K(),s.index=1,s.title="请选择商品")},multipleSelection:e=>{s.cacheItems[s.dialog.info1["page.currentPage"]-1]=e,s.dialog.items=[].concat.apply([],s.cacheItems),s.dialog.items=[...s.dialog.items,...e],s.dialog.items=E.uniqBy(s.dialog.items,"uuid")},getOrder:K,handlePrev:J,handleDetermine:()=>{s.info=o(o({},s.info),s.itemCache),s.info.remark="",s.selectParams.orderUuid=s.itemCache.orderUuid;let e=s.dialog.items;s.data=e.map((e=>(e.receiveNum=e.receiveNum||void 0,e))),s.visibility=!1,s.pot=0,s.disabled=!0,s.isDisabled=!0,s.supplierDisabled=!0,J()},totalNum:g,clearMsg:()=>{l.selectArr=[]},ExportExcel:async()=>{await N()},handlePreview:e=>{let i=new FormData;i.append("file",e.raw),i.append("supplierName",s.supplierName),D(i).then((e=>{s.data=e.receiveDetailVOS.map((e=>(e.receiveNum=e.receiveNum||void 0,e))),B.success(`导入成功${e.successCount}条,失败${e.failCount}`)}))},handlcurrentChange:e=>{s.pagination.page=e,Z()},handlSizeChange:e=>{s.pagination.size=e,Z()},handleRender:u,delTable:ee,closeDialog:e=>{2==e&&(s.isDisabled=!0)},supplierSelectList2Event:te,getSupplier:X,getRefuseReason:n})}};const ce=e=>(re("data-v-8b27f55a"),e=e(),de(),e),me=ce((()=>ie("div",{class:"title"},"采购收货单详情",-1))),fe={key:0,class:"btn-box"},ge=I("Excle导入 "),be=I("提取采购单 "),he=I("完成 "),ye={class:"top-content"},ve={class:"main"},xe={class:"getInfo"},Ne={class:"text"},ke={class:"block"},we={style:{height:"auto","padding-bottom":"15px"}},De={key:0},Ce={key:1},Te={class:"dialog-footer"},Ue=I("取 消"),Pe=I("上一步"),Se=I("确 定"),je=ce((()=>ie("span",null,[ie("i",{class:"el-icon-error",style:{color:"rgb(245, 108, 108)","font-size":"54px"}})],-1))),ze={style:{position:"absolute",left:"110px",top:"92px"}},Ee={style:{"font-weight":"700"}},_e=ce((()=>ie("div",null,"为停购状态商品, 无法采购",-1))),Be={class:"dialog-footer"},Re=I("我知道了"),Fe={style:{"padding-bottom":"16px"}},Ae={style:{"margin-top":"10px","text-align":"center"}};var qe=ue(pe,[["render",function(e,i,t,a,l,s){const n=V("el-button"),o=V("el-upload"),r=d,b=u,h=p,y=c,v=V("el-pagination"),x=m,N=f,k=V("el-dialog"),w=V("el-step"),D=V("el-steps"),C=g,T=W("loading");return K((J(),Q(C,{close:e.close,route:e.go,"element-loading-spinner":"el-icon-loading","element-loading-text":"导入数据中","t-id":"tab"},{header:X((()=>[me,e.isEdit?(J(),Z("div",fe,[O(o,{ref:"upload","auto-upload":!1,disabled:e.upSet,"file-list":e.fileList,"on-change":a.handlePreview,"show-file-list":!1,accept:"'.xls', '.xlsx'",action:"/gateway/chain-store/file/upload",style:{"margin-top":"-2px"}},{default:X((()=>[O(n,{disabled:e.upSet,size:"small",style:{"margin-right":"10px"},type:"primary"},{default:X((()=>[ge])),_:1},8,["disabled"])])),_:1},8,["disabled","file-list","on-change"]),O(n,{disabled:e.isDisabled,size:"small",type:"primary",onClick:i[0]||(i[0]=e=>a.handleGetOrder(1))},{default:X((()=>[be])),_:1},8,["disabled"]),O(r,{size:"small",onClick:i[1]||(i[1]=e=>a.handleSubmit(!0))},{default:X((()=>[he])),_:1})])):ee("",!0)])),top:X((()=>[ie("div",ye,[O(b,{ref:"editForm","form-data":e.formInfo,"onUpdate:form-data":i[2]||(i[2]=i=>e.formInfo=i),"submit-form":e.info,"onUpdate:submit-form":i[3]||(i[3]=i=>e.info=i)},null,8,["form-data","submit-form"]),O(b,{"submit-form":e.info,"onUpdate:submit-form":i[4]||(i[4]=i=>e.info=i),"form-data":e.formData3,gutter:24},null,8,["submit-form","form-data"]),a.coldChain?(J(),Q(b,{key:0,ref:"editForm1","form-data":e.formData,"onUpdate:form-data":i[5]||(i[5]=i=>e.formData=i),"submit-form":e.info,"onUpdate:submit-form":i[6]||(i[6]=i=>e.info=i)},null,8,["form-data","submit-form"])):ee("",!0)])])),default:X((()=>[O(x,{ref:"keyBoard",data:e.data.slice((e.pagination.page-1)*e.pagination.size,(e.pagination.page-1)*e.pagination.size+e.pagination.size),down:[".main .select-table .el-table__body-wrapper  .el-table__row"],pot:e.pot,range:[0,1,2,3,4],first:".main .select-input"},{default:X((()=>[ie("div",ve,[O(h,{ref:"baseTable",pageList:e.pagination,"onUpdate:pageList":i[7]||(i[7]=i=>e.pagination=i),columns:e.columns,delTable:a.delTable,"fixed-head":!1,formConfig:{highlightCurrentRow:!0},optionShow:!1,"reduce-num":70,"table-data":e.data.slice((e.pagination.page-1)*e.pagination.size,(e.pagination.page-1)*e.pagination.size+e.pagination.size),"table-data-sum":e.data,class:"select-table","class-id":"tab",onDel:a.delTable},{buttons:X((()=>[ie("div",xe,[ie("div",Ne,[ie("span",null,"商品种类合计："+te(parseFloat(a.totalNum.code.toFixed(2))),1),ie("span",null,"收货数量合计："+te(parseFloat(a.totalNum.receiveNum.toFixed(2))),1),ie("span",null,"含税金额合计："+te(a.totalNum.taxAmount.toFixed(2))+"元",1),ie("span",null,"金额合计："+te(a.totalNum.amount.toFixed(2))+"元",1),ie("span",null,"税额合计："+te(a.totalNum.tax.toFixed(2))+"元",1)])])])),_:1},8,["pageList","columns","delTable","table-data","table-data-sum","onDel"]),O(y,{ref:"selectTable",loading:e.selectLoading,"onUpdate:loading":i[8]||(i[8]=i=>e.selectLoading=i),options:e.selectArr,"onUpdate:options":i[9]||(i[9]=i=>e.selectArr=i),config:{disabled:e.isDetail},"fixed-head":!1,keys:e.keys,props:{label:"userName",value:"drugUuid"},class:"select-input","options-class":"select-option-t",placeholder:"请输入商品编码/助记码/商品名称/条码",onClear:a.clearMsg,onOnInput:a.handleInput,onOnChange:a.handleChange},null,8,["loading","options","config","keys","onClear","onOnInput","onOnChange"]),ie("div",ke,[O(v,{"current-page":e.pagination.page,"page-size":e.pagination.size,"page-sizes":[10,20,50,100],total:e.data.length,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:a.handlcurrentChange,onSizeChange:a.handlSizeChange},null,8,["current-page","page-size","total","onCurrentChange","onSizeChange"])])])])),_:1},8,["data","down","pot"]),O(k,{modelValue:e.visibility,"onUpdate:modelValue":i[14]||(i[14]=i=>e.visibility=i),title:e.title,width:"70%",onClose:i[15]||(i[15]=e=>a.closeDialog(1))},ae({default:X((()=>[ie("div",we,[0===e.index?(J(),Z("div",De,[O(N,{"form-data":e.dialog.formData,"onUpdate:form-data":i[10]||(i[10]=i=>e.dialog.formData=i),"submit-form":e.dialog.info,"onUpdate:submit-form":i[11]||(i[11]=i=>e.dialog.info=i),options:!0,select:a.handleGetOrder},null,8,["form-data","submit-form","select"]),O(h,{columns:e.dialog.columns,"fixed-head":!1,formConfig:{highlightCurrentRow:!0},"option-show":!1,"table-data":e.dialog.data,onOnClick:a.handleTableClick},null,8,["columns","table-data","onOnClick"])])):ee("",!0),1===e.index?(J(),Z("div",Ce,[O(h,{cache:e.dialog.items,columns:e.dialog.columns1,"fixed-head":!1,"multiple-selection":a.multipleSelection,"option-show":!1,pagination:e.dialog.info1,select:a.getOrder,"table-data":e.dialog.data1},null,8,["cache","columns","multiple-selection","pagination","select","table-data"])])):ee("",!0)])])),_:2},[1===e.index?{name:"footer",fn:X((()=>[ie("span",Te,[O(n,{size:"small",onClick:i[12]||(i[12]=i=>e.visibility=!1)},{default:X((()=>[Ue])),_:1}),O(n,{size:"small",type:"primary",onClick:a.handlePrev},{default:X((()=>[Pe])),_:1},8,["onClick"]),O(n,{size:"small",type:"primary",onClick:a.handleDetermine,onClose:i[13]||(i[13]=e=>a.closeDialog(2))},{default:X((()=>[Se])),_:1},8,["onClick"])])]))}:void 0]),1032,["modelValue","title"]),O(k,{modelValue:e.dialogVisible,"onUpdate:modelValue":i[17]||(i[17]=i=>e.dialogVisible=i),"close-on-click-modal":!1,title:"提示",width:"30%"},{footer:X((()=>[ie("span",Be,[O(n,{type:"primary",onClick:i[16]||(i[16]=i=>e.dialogVisible=!1)},{default:X((()=>[Re])),_:1})])])),default:X((()=>[je,ie("div",ze,[ie("span",Ee,te(e.dialogGoodsName),1),ie("span",null,te(e.dialogGoodsDetail),1),_e])])),_:1},8,["modelValue"]),O(k,{modelValue:e.visibility1,"onUpdate:modelValue":i[18]||(i[18]=i=>e.visibility1=i),"close-on-press-escape":!1,"show-close":!1,width:420,title:"节点图"},{default:X((()=>[ie("div",Fe,[O(D,{key:e.index,active:e.active,"align-center":!0,"process-status":"error"},{default:X((()=>[(J(!0),Z(oe,null,le(e.stepsContent,((i,t)=>(J(),Q(w,{key:t,class:se("step"+t)},{description:X((()=>[ie("div",Ae,[ie("div",{style:ne({color:i.active<=e.active?"#313233":"#C0C4CC"})},te(i.title),5),i.description?(J(),Z("div",{key:0,style:ne({"font-size":"16px",color:"成功"==i.description?"#1890FF":"#F56C6C","font-weight":700})},te(i.description?i.description:""),5)):ee("",!0)])])),_:2},1032,["class"])))),128))])),_:1},8,["active"])])])),_:1},8,["modelValue"])])),_:1},8,["close","route"])),[[T,e.loading]])}],["__scopeId","data-v-8b27f55a"]]);export{qe as default};
