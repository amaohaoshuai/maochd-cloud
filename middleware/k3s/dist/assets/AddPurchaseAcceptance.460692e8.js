var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,s=(t,i,a)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[i]=a,n=(e,t)=>{for(var i in t||(t={}))l.call(t,i)&&s(e,i,t[i]);if(a)for(var i of a(t))r.call(t,i)&&s(e,i,t[i]);return e};import{_ as o}from"./SubmitButton.99d990fd.js";import{_ as u}from"./EditForm.8c35f1a6.js";import{_ as c}from"./BaseTable.36f55649.js";import{_ as d}from"./KeyBoard.96ba8d0b.js";import{_ as m}from"./BaseCard.46de0c24.js";import{_ as p}from"./BaseForm.bc55ad6b.js";import{_ as b}from"./InputDate.1acc5e94.js";import{j as h,g as f,e as g,B as y,J as k,Q as D,G as w,S as v,Y as x,i as N,h as C,n as R,D as S,t as j,o as T,a5 as F,w as U,a6 as z,z as P,c as L,v as _,a9 as O,aa as B}from"./@vue.23a4bd1a.js";import{b as q,d as V,_ as E}from"./element-plus.b44d97a8.js";import{_ as I}from"./BaseStencil.46c3d678.js";import{_ as A}from"./BaseName.1aa32b4b.js";import{e as $,r as Y,s as G,f as M,h as H,i as Q}from"./PurchaseAcceptance.9cfc0e35.js";import{u as J}from"./vuex.c868d4e0.js";import{b as W}from"./vue-router.91336ba9.js";import{h as K}from"./moment.08a7f518.js";import{f as X}from"./filter.c2c8f0b9.js";import{a as Z}from"./businessRule.60794e55.js";import{_ as ee}from"./lodash.d7ab6f48.js";import{_ as te}from"./index.ab904951.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";function ie(e){return"function"==typeof e||"[object Object]"===Object.prototype.toString.call(e)&&!x(e)}var ae={name:"AddPurchaseAcceptance",components:{BaseCard:m,SubmitButton:o,EditForm:u,BaseForm:p,BaseTable:c,BaseStencil:I,BaseName:A},setup(){let e=J(),{dict:s}=e.state.common,o=h({refuseReason:s.find((e=>"refuseReason"===e.key)).data,resultList:[],insufficientPrompt:[{batchNumber:"",drugUuid:""}]});const u=e=>{const t=(new Date).getTime(),i=(new Date(e.expireDate)-t)/1e3/3600/24;let a=i>=0&&i<=180?"waring":i<0?"error":"";return e.expireDate?"error"==a?g(y("el-tooltip"),{effect:"dark",content:"过期商品不允许保存",placement:"top-start"},{default:()=>[g("div",null,[g("i",{className:"el-icon-warning",style:"color:rgb(245, 108, 108);margin-right: 10px;"},null)])]}):void 0:g("div",null,null)},c=f(null),d=f(null),m=h({isFlag:!0,isDisabled:!1,oldBusiness:[],mechanism:[],pagination:{page:1,size:10,total:100},baseNameList:["name","specification","unit","manufacturer"],submitNum:0,businessScope:[],baseTable:null,reciveUuid:"",isEdit:!1,isExpires:"",expiresCredential:"",isDetail:!1,queryUuid:"",keyList:[],rejectionReasonsList:[],acceptanceResultsList:[],tabClose:!1,supplierList:[],isShowReceiptList:!1,formData:{inline:!0,labelWidth:"90px",span:6,list:[{label:"开票日期",key:"invoiceTime",type:"DIV"},{label:"供应商名称",key:"supplierName",type:"TEMP",iconStyle:{position:"absolute",left:"50px",top:" 50%",transform:"translateY(-50%)"},render:e=>g("div",null,[e.supplierName?e.supplierName:"-",g(y("el-tooltip"),{class:"item",effect:"dark",content:m.expiresCredential,placement:"top-start"},{default:()=>[g("span",{style:"margin-left:10px"},[k(g("i",{class:"el-icon-warning",style:"color:rgb(245, 108, 108);"},null),[[D,!m.isDetail&&m.isExpires]])])]})])},{label:"门店",require:!0,type:"SELECT",placeholder:"请选择门店",key:"businessUuid",disabled:()=>!!m.isDetail,props:{label:"name",value:"uuid"},config:{onChange:e=>{0==m.tableData.length&&(m.oldBusiness=m.submitForm.businessUuid),m.isDisabled=!1,m.tableData.length>0&&q.confirm("切换当前门店会清空数据!","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{m.tableData=[],m.oldBusiness=m.submitForm.businessUuid,m.isDisabled=!1})).catch((()=>{m.submitForm.businessUuid&&(m.submitForm.businessUuid=m.oldBusiness),m.isDisabled=!0}))}},list:()=>m.mechanism},{label:"随货同行单",key:"peer",type:"DIV"},{label:"采购单编号",key:"orderNo",type:"DIV"},{label:"收货员",key:"receiveUser",type:"DIV"},{label:"收货单编号",key:"receiveNo",type:"DIV"},{label:"创建人",key:"applicant",type:"DIV"},{label:"验收单编号",key:"checkNo",type:"DIV"},{label:"备注",type:"INPUT",key:"remark",disabled:()=>!!m.isDetail,inputType:"textarea",design:{width:"100%"},config:{showWordLimit:!1,maxlength:100,autosize:{minRows:1,maxRows:1}}}]},submitForm:{applicant:""},tableDataType:[],tableData:[],pot:-1,columns:[{width:50,fixed:"left",render:e=>w("div",{innerHTML:'<i class="el-icon-plus"></i>',onClick:()=>{P(e)}})},{title:"序号",type:"index",fixed:"left",formConfig:{width:52}},{key:"code",title:"商品编码",fixed:"left",formConfig:{"show-overflow-tooltip":!1,"min-width":100},render:e=>g("div",null,[g("div",{style:m.isDetail||m.businessScope.indexOf(e.category1)>-1?"":"color: rgb(245, 108, 108)"},[e.code,g(y("el-tooltip"),{class:"item",effect:"dark",content:"该商品不在该供应商的经营范围",placement:"top-start"},{default:()=>[k(g("i",{class:"el-icon-warning",color:"rgb(245,108,108)",size:"small"},null),[[D,!(m.isDetail||m.businessScope.indexOf(e.category1)>-1)]])]})])])},{title:"商品名称/规格/单位/生产厂家",key:"name",fixed:"left",width:256,render:e=>w(A,{row:e,list:m.baseNameList}),formConfig:{"show-overflow-tooltip":!1}},{key:"receiveNum",title:"收货数量",align:"right",width:120},{key:"batchNumber",title:"批号",width:200,require:!0,header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("批号")]),render:(e,t,i,a)=>g("div",null,[g(y("el-input"),{disabled:m.isDetail,class:e[`batchNumber_${a}`],modelValue:e.batchNumber,size:"mini",maxlength:"25",width:"180",onInput:t=>{_(e,"batchNumber",t)},onChange:t=>{_(e,"batchNumber",t)},placeholder:"请输入",clearable:!0},null)])},{key:"productionDate",title:"生产日期",width:150,render:(e,t,i,a)=>g("div",null,[g(b,{disabled:m.isDetail,data:e,text:"productionDate",onChange:t=>{!t||X(t)>=X((new Date).getTime())?e.productionDate="":e.productionDate=t}},null)])},{key:"expireDate",title:"有效期至",width:150,require:!0,formConfig:{"show-overflow-tooltip":!1},header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("有效期至")]),render:(e,t,i,a)=>{const l=(new Date).getTime(),r=(new Date(e.expireDate)-l)/1e3/3600/24;let s="";return s=1==m.isDetail?"":r>=0&&r<=180?"waring":r<0?"error":"",g(b,{class:e[`expireDate_${a}`],slots:()=>u(e),data:e,isStyle:"waring"==s,disabled:m.isDetail,text:"expireDate",onChange:t=>{!t||X(t)<=X((new Date).getTime())?e.expireDate=t:(e.expireDate=t,m.expireDate=t)}},null)}},{key:"checkNum",title:"验收数量",width:150,rule:[0],require:!0,header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("验收数量")]),render:(e,t,i,a)=>{let l=ee.find(o.insufficientPrompt,{batchNumber:e.batchNumber}),r=ee.find(o.insufficientPrompt,{drugUuid:e.drugUuid});return g("div",null,l&&r?[g(y("el-input-number"),{size:"mini",disabled:m.isDetail,stepStrictly:!0,class:e[`checkNum_${a}`],min:-999999.999999,max:999999.999999,modelValue:e.checkNum||void 0,onChange:t=>{_(e,"checkNum",t),setTimeout((()=>{0===t&&_(e,"checkNum",void 0),e.checkNum=t}))},placeholder:"请输入"},null),g(y("el-tooltip"),{effect:"dark",content:"批号数量库存不足",placement:"top-start",class:"insufficient"},{default:()=>[g("div",null,[g("i",{className:"el-icon-warning",style:"color:rgb(245, 108, 108);margin-right: 10px;"},null)])]})]:[g(y("el-input-number"),{size:"mini",disabled:m.isDetail,stepStrictly:!0,class:e[`checkNum_${a}`],min:-999999.999999,max:999999.999999,modelValue:e.checkNum||void 0,onChange:t=>{_(e,"checkNum",t),setTimeout((()=>{0===t&&_(e,"checkNum",void 0),e.checkNum=t}))},placeholder:"请输入"},null)])}},{key:"checkResult",title:"验收结果",width:140,header:()=>g("div",{class:"table-title"},[g("i",null,null),v("验收结果")]),render:(e,t,i,a)=>{let l;return g("div",null,[g(y("el-select"),{disabled:m.isDetail,size:"mini",class:e[`checkResult_${a}`],modelValue:e.checkResult,placeholder:"请选择",onChange:t=>{_(e,"checkResult",t)}},ie(l=o.resultList.map((e=>g(y("el-option"),{key:e.key,label:e.value,value:e.value},null))))?l:{default:()=>[l]})])}},{title:"拒收数量",key:"returnNum",width:150,require:!1,render:(e,t,i,a)=>g("div",null,[g(y("el-input-number"),{size:"mini",disabled:m.isDetail||e.checkNum<0,step:1e-6,stepStrictly:!0,modelValue:e.returnNum||void 0,min:0,max:1e5,onChange:t=>{_(e,"returnNum",t,a)},placeholder:"请输入"},null)])},{key:"refuseReason",title:"拒收原因",width:160,require:!1,header:e=>g("div",{class:"table-title"},[v("拒收原因")]),render:(e,t,i,a)=>{let l;return g("div",null,[g(y("el-select"),{size:"mini",class:e[`refuseReason_${a}`],modelValue:e.refuseReason,placeholder:"请选择",disabled:m.isDetail||e.isNeedReason,onInput:t=>{_(e,"refuseReason",t)},onChange:t=>{_(e,"refuseReason",t)}},ie(l=o.refuseReason.map((e=>g(y("el-option"),{key:e.key,label:e.key,value:e.key},null))))?l:{default:()=>[l]})])}},{key:"taxPaid",title:"含税进价",width:150,align:"right",render:e=>g("div",null,[g("span",null,[e.taxPaid]),k(g("i",{className:"el-icon-top",color:"rgb(245,108,108)",size:"small"},null),[[D,!m.isDetail&&e.taxPaid>e.purchasePrice]])])},{key:"price",title:"进价",width:150,align:"right"},{key:"taxAmount",title:"含税金额",width:150,align:"right",render:e=>{let t=e.taxPaid*e.checkNum||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"amount",title:"金额",width:150,align:"right",render:e=>{let t=e.price*e.checkNum||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"tax",title:"税额",width:150,align:"right",render:e=>{let t=(e.taxPaid*e.checkNum*1e6-e.price*e.checkNum*1e6)/1e6||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"retailPrice",title:"零售价",width:150,align:"right"},{key:"retailAmount",title:"零售金额",width:150,align:"right",render:e=>{let t=e.retailPrice*e.checkNum||0;return g("div",null,[t||"-"])}},{key:"inputTaxRate",title:"进项税率(%)",width:110,align:"right"},{key:"approvalNumber",title:"批准文号",width:224},{key:"holderPermit",title:"上市许可持有人",width:170,isShowTwo:!0,formConfig:{"show-overflow-tooltip":!1}},{key:"medicineBeverage",title:"中药饮片产地",width:110},{title:"操作",key:"options",render:e=>{let t=[{type:"text",innerHTML:"删除",style:"color:rgb(245, 108, 108)",show:!!e.isShowDelet,onClick:()=>{L(e)}}];return w("div",t.map((e=>{if(!e.show)return w(V,e)})))}}],columns1:[{title:"序号",type:"index",fixed:"left",formConfig:{width:52}},{key:"code",title:"商品编码",fixed:"left",formConfig:{"show-overflow-tooltip":!1,"min-width":100},render:e=>g("div",null,[g("div",{style:m.isDetail||m.businessScope.indexOf(e.category1)>-1?"":"color: rgb(245, 108, 108)"},[e.code,g(y("el-tooltip"),{class:"item",effect:"dark",content:"该商品不在该供应商的经营范围",placement:"top-start"},{default:()=>[k(g("i",{class:"el-icon-warning",color:"rgb(245,108,108)",size:"small"},null),[[D,!(m.isDetail||m.businessScope.indexOf(e.category1)>-1)]])]})])])},{title:"商品名称/规格/单位/生产厂家",key:"name",fixed:"left",width:256,render:e=>w(A,{row:e,list:m.baseNameList}),formConfig:{"show-overflow-tooltip":!1}},{key:"receiveNum",title:"收货数量",align:"right",width:120},{key:"batchNumber",title:"批号",width:200,require:!0,header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("批号")]),render:(e,t,i,a)=>g("div",null,[g(y("el-input"),{disabled:m.isDetail,class:e[`batchNumber_${a}`],modelValue:e.batchNumber,size:"mini",maxlength:"25",width:"180",onInput:t=>{_(e,"batchNumber",t)},onChange:t=>{_(e,"batchNumber",t)},placeholder:"请输入",clearable:!0},null)])},{key:"productionDate",title:"生产日期",width:150,render:(e,t,i,a)=>g("div",null,[g(b,{disabled:m.isDetail,data:e,text:"productionDate",onChange:t=>{!t||X(t)>=X((new Date).getTime())?e.productionDate="":e.productionDate=t}},null)])},{key:"expireDate",title:"有效期至",width:150,require:!0,formConfig:{"show-overflow-tooltip":!1},header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("有效期至")]),render:(e,t,i,a)=>{const l=(new Date).getTime(),r=(new Date(e.expireDate)-l)/1e3/3600/24;let s="";return s=1==m.isDetail?"":r>=0&&r<=180?"waring":r<0?"error":"",g(b,{class:e[`expireDate_${a}`],slots:()=>u(e),data:e,isStyle:"waring"==s,disabled:m.isDetail,text:"expireDate",onChange:t=>{!t||X(t)<=X((new Date).getTime())?e.expireDate=t:(e.expireDate=t,m.expireDate=t)}},null)}},{key:"checkNum",title:"验收数量",width:150,require:!0,header:()=>g("div",{class:"table-title"},[g("i",null,[v("*")]),v("验收数量")]),render:(e,t,i,a)=>g(y("el-input-number"),{size:"mini",className:e[`checkNum_${a}`],stepStrictly:!0,disabled:m.isDetail,min:-999999.999999,max:999999.999999,placeholder:"请输入",modelValue:e.checkNum,onChange:t=>{_(e,"checkNum",t),setTimeout((()=>{0===t&&_(e,"checkNum",void 0),e.checkNum=t}))}},null)},{key:"checkResult",title:"验收结果",width:140,header:()=>g("div",{class:"table-title"},[g("i",null,null),v("验收结果")]),render:(e,t,i,a)=>{let l;return g("div",null,[g(y("el-select"),{disabled:m.isDetail,size:"mini",class:e[`checkResult_${a}`],modelValue:e.checkResult,placeholder:"请选择",onChange:t=>{_(e,"checkResult",t)}},ie(l=o.resultList.map((e=>g(y("el-option"),{key:e.key,label:e.value,value:e.value},null))))?l:{default:()=>[l]})])}},{title:"拒收数量",key:"returnNum",width:150,require:!1,render:(e,t,i,a)=>g("div",null,[g(y("el-input-number"),{size:"mini",disabled:m.isDetail,step:1e-6,stepStrictly:!0,modelValue:e.returnNum||void 0,min:0,max:1e5,onChange:t=>{_(e,"returnNum",t,a)},placeholder:"请输入"},null)])},{key:"refuseReason",title:"拒收原因",width:160,require:!1,header:e=>g("div",{class:"table-title"},[v("拒收原因")]),render:(e,t,i,a)=>{let l;return g("div",null,[g(y("el-select"),{size:"mini",class:e[`refuseReason_${a}`],modelValue:e.refuseReason,placeholder:"请选择",disabled:m.isDetail||e.isNeedReason,onInput:t=>{_(e,"refuseReason",t)},onChange:t=>{_(e,"refuseReason",t)}},ie(l=o.refuseReason.map((e=>g(y("el-option"),{key:e.key,label:e.key,value:e.key},null))))?l:{default:()=>[l]})])}},{key:"taxPaid",title:"含税进价",width:150,align:"right",render:e=>g("div",null,[g("span",null,[e.taxPaid]),k(g("i",{className:"el-icon-top",color:"rgb(245,108,108)",size:"small"},null),[[D,!m.isDetail&&e.taxPaid>e.purchasePrice]])])},{key:"price",title:"进价",width:150,align:"right"},{key:"taxAmount",title:"含税金额",width:150,align:"right",render:e=>{let t=e.taxPaid*e.checkNum||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"amount",title:"金额",width:150,align:"right",render:e=>{let t=e.price*e.checkNum||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"tax",title:"税额",width:150,align:"right",render:e=>{let t=(e.taxPaid*e.checkNum*1e6-e.price*e.checkNum*1e6)/1e6||0;return t=t.toFixed(2),g("div",null,[t||"-"])}},{key:"retailPrice",title:"零售价",width:150,align:"right"},{key:"retailAmount",title:"零售金额",width:150,align:"right",render:e=>{let t=e.retailPrice*e.checkNum||0;return g("div",null,[t||"-"])}},{key:"inputTaxRate",title:"进项税率(%)",width:110,align:"right"},{key:"approvalNumber",title:"批准文号",width:224},{key:"holderPermit",title:"上市许可持有人",width:170,isShowTwo:!0,formConfig:{"show-overflow-tooltip":!1}},{key:"medicineBeverage",title:"中药饮片产地",width:110}],receiptFormData:{inline:!0,labelWidth:"82px",config:{size:"medium"},list:[{label:"供应商名称",type:"SELECT",key:"supplierName",list:()=>m.supplierList},{label:"收货单编号",type:"INPUT",key:"receiveNo"},{label:"门店",require:!0,type:"SELECT",placeholder:"请选择门店",key:"businessUuid",disabled:()=>!0,props:{label:"name",value:"uuid"},list:()=>m.mechanism}]},receiptTableData:[],receiptColumns:[{type:"index",title:"序号",formConfig:{width:50}},{key:"receiveNo",title:"收货单编号",width:135},{key:"orderNo",title:"采购单编号",width:135},{key:"user",title:"收货员",width:78},{key:"supplierName",title:"供应商名称",wdith:176},{key:"category1",title:"商品种类",align:"right",width:80},{key:"totalAmountTax",title:"含税金额合计",align:"right",wdith:150}],receiptSubmitForm:{"page.currentPage":1,"page.pageSize":10,orderField:"createTime",orderDirection:"desc",status:0,businessUuid:""},currentRow:{},currentObj:{},receiptConfig:{"highlight-current-row":!0},loading:!1}),p=()=>{let e=m.submitForm;e.detailVOs=m.tableData,ae.query.uuid?(e.status=0,e.uuid=ae.query.uuid):e.status=0;let t={};m.tableData.forEach(((e,i)=>{let a=e.inputUuid;t[a]?t[a]++:t[a]=1}));for(let i in t){let e=0;for(let t=0;t<m.tableData.length;t++)m.tableData[t].inputUuid==i&&(m.tableData[t].name,m.tableData[t].receiveNum,e+=1e6*(m.tableData[t].checkNum||0)+1e6*(m.tableData[t].returnNum||0))}$(e).then((e=>{if(0===e.diffDateList.length){if(0===e.sameTaxPaidList.length)return 0!==e.unStockList.length?(e.unStockList.map(((e,t)=>{let i={};i.batchNumber=e.split(":")[0],i.drugUuid=e.split(":")[1],o.insufficientPrompt.push(i)})),void o.insufficientPrompt.splice(0,1)):void(m.tabClose=!0);E.error("同商品同批号同有效期同进价时不允许提交！")}else E.error("商品批号相同时有效期/生产日期不同不允许提交！")}))},x=()=>{m.receiptSubmitForm={"page.currentPage":1,"page.pageSize":10,orderField:"createTime",orderDirection:"desc",status:0,businessUuid:m.submitForm.businessUuid}},T=()=>{m.currentObj.uuid?(z(m.currentObj.uuid),m.isShowReceiptList=!1):E.error("还未选择收货单")},F=async()=>{let e=m.receiptSubmitForm,{total:t}=e,i=((e,t)=>{var i={};for(var s in e)l.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&a)for(var s of a(e))t.indexOf(s)<0&&r.call(e,s)&&(i[s]=e[s]);return i})(e,["total"]),s=n({businessUuid:m.submitForm.businessUuid},i);Y(s).then((e=>{m.receiptTableData=e.list,m.receiptSubmitForm.total=e.totalElements}))},U=()=>{G().then((e=>{let t=e.map((function(e,t){return{label:e.supplierName,value:e.supplierName}}));m.supplierList=t}))},z=t=>{M(t).then((t=>{let i=t.info,a={};a.applicant=e.state.common.info.userName,a.business=i.business,a.peer=i.peer,a.invoiceTime=i.invoiceTime,a.supplierName=i.supplierName,a.supplierUuid=i.supplierUuid,a.receiveNo=i.receiveNo,a.receiveUser=i.createUser,a.orderNo=i.orderNo,a.remark="",a.receiveUuid=i.receiveUuid,a.businessUuid=i.businessUuid;let l=t.details,r=[];l.map(((e,t)=>{l[t].checkNum=l[t].receiveNum,l[t].returnNum=0,l[t].checkResult="合格",l[t].refuseReason="",l[t].isNeedReason=!0,l[t].inputUuid||(l[t].inputUuid=e.uuid),r.push(l[t].code)}));let s=Array.from(new Set(r));m.tableData=l,m.submitForm=a,m.keyList=s,m.reciveUuid=m.tableData[0].receiveUuid,H(m.reciveUuid).then((e=>{m.isExpires=e.expires,m.expiresCredential=e.expiresCredential,m.businessScope=e.basicInfo.businessScope}))}))},P=e=>{let t,i=JSON.parse(JSON.stringify(e)),a=m.tableData;for(let l=0;l<a.length;l++)e.uuid==a[l].uuid&&(t=l);i.batchNumber="",i.productionDate="",i.expireDate="",i.checkNum="",i.returnNum="",i.refuseReason="",i.medicineBeverage="",i.uuid="",i.checkResult="合格",a.splice(t+1,0,i),m.tableData=a},L=e=>{let t,i=m.tableData;for(let a=0;a<i.length;a++)e.uuid==i[a].uuid&&(t=a);i.splice(t,1),m.tableData=i,m.pot=t-1},_=(e,t,i,a)=>{e[t]=i,"returnNum"==t&&(i>0?m.tableData[a].isNeedReason=!1:(m.tableData[a].isNeedReason=!0,m.tableData[a].refuseReason=""))};N((()=>m.tableData.length),((e,t)=>{let i=m.tableData,a={};for(let l=0;l<i.length;l++){let e=i[l].code;a[e]?a[e]++:a[e]=1}for(let l=0;l<i.length;l++)for(let e in a)i[l].code==e&&(1==a[e]?i[l].isShowDelet=!0:i[l].isShowDelet=!1)}));const O=C((()=>{let e=0;return m.tableData.map((t=>{t.checkNum&&(e+=1e5*t.checkNum)})),e/1e5})),B=C((()=>{let e=0;return m.tableData.map((t=>{t.taxPaid*t.checkNum&&(e+=t.taxPaid*t.checkNum)})),e.toFixed(2)})),I=C((()=>{let e=0;return m.tableData.map((t=>{t.price*t.checkNum&&(e+=t.price*t.checkNum)})),e.toFixed(2)})),te=C((()=>{let e=0;return m.tableData.map((t=>{t.taxPaid&&t.checkNum&&(e+=(t.taxPaid*t.checkNum*1e6-t.price*t.checkNum*1e6)/1e6)})),e.toFixed(2)})),ae=W(),le=()=>{if(o.resultList=[{label:"合格",value:"合格"},{label:"不合格",value:"不合格"}],ae.query.uuid){m.queryUuid=ae.query.uuid;let e={uuid:ae.query.uuid};Q(e).then((e=>{m.tableData=e.detailVOs,m.submitForm=e,m.businessScope=e.basicInfo.businessScope,m.isExpires=e.isExpires,m.expiresCredential=e.expiresCredential;let t=e.detailVOs,i=[];t.map(((e,a)=>{i.push(t[a].code)})),m.tableData.map(((e,t)=>{e.returnNum||(e.isNeedReason=!0)}));let a=Array.from(new Set(i));m.keyList=a}))}else m.queryUuid=void 0,m.businessScope=[],m.isExpires=!1,m.expiresCredential="",m.receiptTableData=[],m.tableData=[],m.submitForm={},m.tabClose=!1,m.isShowReceiptList=!1,m.keyList=[],m.acceptanceQuantity=0,m.amountIncludingTax=0,m.moneyTotal=0,m.taxAmount=0,m.isDetail=!1},re=()=>{q.confirm("请选择门店后,再进行操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{m.isFlag=!0})).catch((()=>{m.isFlag=!0}))};return R((()=>{U(),m.isDetail=!!ae.query.isDetail,m.isDetail&&m.columns.splice(0,1)})),S((async()=>{m.isDetail=!!ae.query.isDetail,m.isEdit=ae.query.isEdit,m.mechanism=await e.dispatch("common/mechanism"),m.queryUuid!==ae.query.uuid&&le(),m.submitForm.applicant=e.state.common.info.userName,Z(m.submitForm,m.mechanism),m.submitForm.receiveUser=e.state.common.info.userName})),se=n(n({},j(m)),j(o)),t(se,i({ruleForm:c,receiptForm:d,submitAdd:async e=>{if(!m.submitForm.businessUuid)return void re();let{baseTable:t}=m,i=!1,a=!1;const l=(new Date).getTime();let r=!0;if(r=t.verification(),0==m.tableData.length)return E.warning("尚未提取收货单"),!1;let s=!1,n=!0;if(m.tableData.forEach(((e,t)=>{!e.returnNum||""!==e.refuseReason&&null!=e.refuseReason&&null!=e.refuseReason?e[`refuseReason_${t}`]="":(e[`refuseReason_${t}`]="error",n=!1,s=!1),K(e.expireDate).diff(K(new Date,"YYYY-MM-DD"),"days")<=180&&(i=!0),(new Date(e.expireDate)-l)/1e3/3600/24<0&&(a=!0)})),s&&E.error("拒收数量大于0时，必须填写拒收原因"),!r||!n)return!1;a?E.error("过期商品不允许保存"):i?q.confirm("存在近效期商品，是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((async()=>{p()})):p()},showReceipt:()=>{m.submitForm.businessUuid?(m.isDisabled=!0,m.receiptTableData=[],m.isShowReceiptList=!0,x(),F()):re()},cancleReceipt:()=>{m.isShowReceiptList=!1,m.currentObj={},m.isDisabled=!1},subReceipt:T,currentRow:e=>{m.currentObj=e},subReceiptdbl:({type:e})=>{"dblclick"===e&&T()},getReceivingGoodsList:F,getsupplierList:U,getReceivingGoodDetail:z,acceptanceQuantity:O,amountIncludingTax:B,moneyTotal:I,taxAmount:te,getDetail:le,toClose:e=>{m.currentObj={},"function"==typeof e&&e()},resetSubmitForm:x,handlcurrentChange:e=>{m.pagination.page=e},handlSizeChange:e=>{m.pagination.size=e},handleRender:u,submitTips:re,closeDialog:()=>{m.isDisabled=!1}}));var se}};const le={class:"addPurchaseAcceptance"},re=(e=>(O("data-v-3d7a2668"),e=e(),B(),e))((()=>z("span",{style:{"font-size":"16px","font-weight":"600"}}," 采购验收详情 ",-1))),se=v(" 提取收货单 "),ne=v(" 完成 "),oe={class:"top-content"},ue={class:"main"},ce={class:"titleFlex"},de={class:"titleFlexRight"},me={class:"block"},pe={class:"dialog-footer"},be=v("取消"),he=v(" 确定 ");var fe=te(ae,[["render",function(e,t,i,a,l,r){const s=o,n=u,b=c,h=y("el-pagination"),f=d,w=m,v=p,x=y("el-button"),N=y("el-dialog");return T(),F("div",le,[g(w,{route:{path:"/purchase/purchase-acceptance"},close:e.tabClose,"t-id":"tab",backTips:!e.isDetail},{header:U((()=>[re,z("div",null,[k(g(s,{class:"btn",config:{size:"small"},onClick:a.showReceipt,disabled:e.isDisabled},{default:U((()=>[se])),_:1},8,["onClick","disabled"]),[[D,!e.isDetail]]),k(g(s,{class:"btn",onClick:t[0]||(t[0]=e=>a.submitAdd(!0)),config:{size:"small"}},{default:U((()=>[ne])),_:1},512),[[D,!e.isDetail]])])])),top:U((()=>[z("div",oe,[g(n,{"form-data":e.formData,"onUpdate:form-data":t[1]||(t[1]=t=>e.formData=t),"submit-form":e.submitForm,"onUpdate:submit-form":t[2]||(t[2]=t=>e.submitForm=t),ref:"ruleForm"},null,8,["form-data","submit-form"])])])),default:U((()=>[g(f,{data:e.tableData,down:[".main .select-table .el-table__body-wrapper  .el-table__row"],range:[0,1,2,3,4],pot:e.pot},{default:U((()=>[z("div",ue,[z("div",ce,[z("div",de,[z("span",null," 商品种类合计："+P(0==e.keyList.length?"0":e.keyList.length),1),z("span",null,"验收数量合计："+P(a.acceptanceQuantity),1),z("span",null,"含税金额合计："+P(a.amountIncludingTax)+"元",1),z("span",null,"金额合计："+P(a.moneyTotal)+"元",1),z("span",null,"税额合计："+P(a.taxAmount)+"元",1)])]),g(b,{"fixed-head":!1,class:"select-table",style:{"margin-top":"10px"},"table-data":e.tableData.slice((e.pagination.page-1)*e.pagination.size,(e.pagination.page-1)*e.pagination.size+e.pagination.size),columns:e.isDetail?e.columns1:e.columns,ref:"baseTable","class-id":"tab","reduce-num":110,"option-show":!e.isDetail},null,8,["table-data","columns","option-show"]),z("div",me,[g(h,{"current-page":e.pagination.page,"page-sizes":[10,20,50,100],"page-size":e.pagination.size,layout:"total, sizes, prev, pager, next, jumper",total:e.tableData.length,onCurrentChange:a.handlcurrentChange,onSizeChange:a.handlSizeChange},null,8,["current-page","page-size","total","onCurrentChange","onSizeChange"])])])])),_:1},8,["data","down","pot"])])),_:1},8,["close","backTips"]),e.isShowReceiptList?(T(),L(N,{key:0,modelValue:e.isShowReceiptList,"onUpdate:modelValue":t[4]||(t[4]=t=>e.isShowReceiptList=t),title:"请选择收货单",width:"1200px","before-close":a.toClose,onClose:a.closeDialog},{footer:U((()=>[z("span",pe,[g(x,{onClick:a.cancleReceipt,size:"small"},{default:U((()=>[be])),_:1},8,["onClick"]),g(s,{size:"small",class:"receiptBtnSub",loading:e.loading,onClick:a.subReceipt},{default:U((()=>[he])),_:1},8,["loading","onClick"])])])),default:U((()=>[g(v,{"form-data":e.receiptFormData,"submit-form":e.receiptSubmitForm,"onUpdate:submit-form":t[3]||(t[3]=t=>e.receiptSubmitForm=t),options:!0,select:a.getReceivingGoodsList,ref:"receiptForm"},null,8,["form-data","submit-form","select"]),g(b,{maxHeight:384,"table-data":e.receiptTableData,columns:e.receiptColumns,options:!0,optionShow:!1,onOnClick:a.subReceiptdbl,pagination:e.receiptSubmitForm,currentRow:a.currentRow,formConfig:e.receiptConfig,select:a.getReceivingGoodsList},null,8,["table-data","columns","onOnClick","pagination","currentRow","formConfig","select"])])),_:1},8,["modelValue","before-close","onClose"])):_("",!0)])}],["__scopeId","data-v-3d7a2668"]]);export{fe as default};
