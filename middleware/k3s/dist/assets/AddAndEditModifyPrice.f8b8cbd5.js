var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,r=(e,t)=>{for(var a in t||(t={}))n.call(t,a)&&l(e,a,t[a]);if(i)for(var a of i(t))s.call(t,a)&&l(e,a,t[a]);return e};import{_ as o}from"./SubmitButton.99d990fd.js";import{_ as d}from"./EditForm.8c35f1a6.js";import{_ as u}from"./BaseTable.36f55649.js";import{_ as p}from"./SelectTable.80e1f2f6.js";import{_ as c}from"./KeyBoard.96ba8d0b.js";import{_ as m}from"./BaseCard.46de0c24.js";import{_ as b}from"./BaseName.1aa32b4b.js";import{b as h}from"./vue-router.91336ba9.js";import{m as f,u as g}from"./vuex.c868d4e0.js";import{b as y}from"./BatchNumber.b846d4bb.js";import{_ as w}from"./lodash.d7ab6f48.js";import{_ as v}from"./element-plus.b44d97a8.js";import{g as P}from"./index.1eb722f1.js";import{u as j,q as k,p as x}from"./index.6a02aeaf.js";import{j as z,h as C,e as M,S as U,B as T,D as _,t as N,o as I,c as S,w as R,a5 as D,v as O,a6 as q,a9 as $,aa as F}from"./@vue.23a4bd1a.js";import{_ as V}from"./index.ab904951.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";var B={name:"AddAndEditModifyPrice",components:{SelectTable:p},setup(){let e=h();const i=f("common",["menus","info","tabs","tabActive"]);let n=g(),s=z({businessMechanismList:[],batchObject:{productUuid:"",batchNum:""},selectArr:[],keys:["code","name","dosageForm","specification","manufacturer"],batchKeys:["batchNum","batchNumIn","overallPackNum","deleavePackNum"],batchHeader:["编码","品名","剂型","规格","生产厂家"],batchNumberIn:{},batchProps:{label:"batchNumIn",value:"batchNumIn"},top:{"margin-top":"5px"},design:{width:"220px",height:"36px"},barchWidth:{width:"160px"},uuid:e.query.uuid,status:e.query.type}),l=z({userInfo:C(i.info.bind({$store:n})),selectTable:null,pagination:{page:1,size:10,total:100},storeUuid:"",index:0,editForm:null,editForm1:null,baseTable:null,keyBoard:null,selectParams:{orderUuid:"",fuzzyValue:""},close:!1,go:{path:"/commodity-manage/modify-price"},config:{size:"medium"},pot:-1,query:{},formInfo:{labelWidth:"90px",span:8,list:[{label:"调价单编号",type:"DIV",key:"number",render:()=>M("div",null,[l.number||"-"])},{label:"创建人 ",type:"DIV",key:"creator"},{label:"制单时间",type:"DIV",key:"createTime",render:()=>M("div",null,[l.createTime||"-"])},{label:"门店",type:"SELECT",key:"businessUuid",require:!0,props:{label:"mechanismName",value:"uuid"},list:()=>s.businessMechanismList,disabled:()=>"see"==s.status||0==l.userInfo.openMultipleStores,config:{multiple:!0,onChange:e=>{let t=[];for(let a=0;a<e.length;a++){let i=w.find(s.businessMechanismList,{uuid:e[a]});t.push(i.mechanismName)}l.info.business=t}}}]},info:{creator:n.state.common.info.userName},columns:[{title:"序号",type:"index",formConfig:{width:50}},{title:"商品编码",key:"code",width:150},{title:"商品名称/规格/单位/生产厂家",key:"name",formConfig:{minWidth:180},render:e=>M(b,{row:e},null)},{title:0==C(i.info.bind({$store:n})).value.openMultipleStores?"零售价":"参考零售价",key:"oldRetailPrice",width:150,align:"right"},{title:"新零售价",key:"newRetailPrice",width:150,require:!0,header:()=>M("div",{class:"table-title"},[M("i",null,[U("*")]),U("新零售价")]),render:(e,t,a,i)=>M(T("el-input-number"),{style:"width:100px",class:e[`newRetailPrice_${i}`],size:"medium",precision:4,max:99999999.9999,min:0,modelValue:e.newRetailPrice||void 0,onChange:t=>{d(e,"newRetailPrice",t,i)},placeholder:"请输入"},null)},{title:"零售价差额",key:"retailPriceDiff",width:200,align:"right"},{title:0==C(i.info.bind({$store:n})).value.openMultipleStores?"会员价":"参考会员价",key:"oldMemberPrice",width:150,align:"right"},{title:"新会员价",key:"newMemberPrice",width:150,render:(e,t,a,i)=>M(T("el-input-number"),{style:"width:100px",class:e[`newMemberPrice_${i}`],size:"medium",precision:4,max:99999999.9999,min:0,modelValue:e.newMemberPrice||void 0,placeholder:"请输入",onChange:t=>{o(e,"newMemberPrice",t,i)}},null)},{title:"备注",key:"note",width:256,render:(e,t,a,i)=>M(T("el-input"),{style:"width:200px",class:e[`note_${i}`],maxlength:"100",modelValue:e.note,placeholder:"请输入",onInput:t=>{e.note=t},onChange:t=>{e.note=t}},null)},{title:"操作",key:"options",width:150,render:(e,t,a,i)=>M(T("el-button"),{type:"text",class:"delete",onClick:()=>{l.data.splice(i,1),l.pot=i}},{default:()=>[U("删除")]})}],columns1:[{title:"序号",type:"index",formConfig:{width:50}},{title:"商品编码",key:"code",width:150},{title:"商品名称/规格/单位/生产厂家",key:"name",render:e=>M(b,{row:e},null),formConfig:{"min-width":220}},{title:0==C(i.info.bind({$store:n})).value.openMultipleStores?"零售价":"参考零售价",key:"oldRetailPrice",width:150,align:"right"},{title:"新零售价",key:"newRetailPrice",width:150,require:!0,header:()=>M("div",{class:"table-title"},[M("i",null,[U("*")]),U("新零售价")]),render:(e,t,a,i)=>M(T("el-input-number"),{style:"width:100px",class:e[`newRetailPrice_${i}`],size:"medium",precision:6,disabled:"see"===s.status,max:99999999.999999,min:-99999999.999999,modelValue:e.newRetailPrice||void 0,onChange:t=>{d(e,"newRetailPrice",t,i)},placeholder:"请输入"},null)},{title:"零售价差额",key:"retailPriceDiff",width:200,align:"right"},{title:0==C(i.info.bind({$store:n})).value.openMultipleStores?"会员价":"参考会员价",key:"oldMemberPrice",width:150,align:"right"},{title:"新会员价",key:"newMemberPrice",width:150,render:(e,t,a,i)=>M(T("el-input-number"),{style:"width:100px",class:e[`newMemberPrice_${i}`],size:"medium",precision:6,max:99999999.999999,min:1e-6,disabled:"see"===s.status,modelValue:e.newMemberPrice||void 0,placeholder:"请输入",onChange:t=>{o(e,"newMemberPrice",t,i)}},null)},{title:"备注",key:"note",width:256,render:(e,t,a,i)=>M(T("el-input"),{style:"width:200px",class:e[`note_${i}`],maxlength:"100",disabled:"see"===s.status,modelValue:e.note,placeholder:"请输入",onInput:t=>{e.note=t},onChange:t=>{e.note=t}},null)}],data:[]});const o=(e,t,a,i)=>{0==Number(a)&&v.warning("新会员价不能为0"),e.newMemberPrice=a},d=(e,t,a,i)=>{if(e[t]=0===a?a.toFixed(6):a,e[t]=a,e[t]){let t=((1e6*e.newRetailPrice-1e6*e.oldRetailPrice)/1e6).toFixed(2),a=(e.newRetailPrice/(1+e.outputTaxRate/100)-e.overallPackPrice)/(e.newRetailPrice/(1+e.outputTaxRate/100))*100;e.retailPriceDiff=t,e.grossMargin=a.toFixed(2)}else e.retailPriceDiff=null,e.grossMargin=null},u=async e=>{let t={uuid:e};const a=await x(t);l.info=a;let i=a.business,n=a.businessUuid;l.info.businessUuid=n,l.info.mechanismName=i,l.data=a.adjustPriceDetails,l.data.map((e=>{e.name=e.productName}))};_((()=>{let{query:t}=e;s.status=t.type,s.uuid=t.uuid,l.storeUuid!==t.uuid&&(async()=>{let{query:t}=e;const a=await P(l.submitForm);let i=[];if(0==l.userInfo.openMultipleStores){let e=[];for(let t=0;t<a.length;t++)i.push(a[t].uuid),e.push(a[t].mechanismName);l.info.business=e}a&&a.length>0&&(l.info.businessUuid=i,s.businessMechanismList=a),e.query.uuid?(l.storeUuid=t.uuid,u(t.uuid)):(l.data=[],l.storeUuid=void 0,l.selectParams.orderUuid=""),l.query=w.cloneDeep(t)})()}));return p=r(r({},N(l)),N(s)),t(p,a({getDetail:u,handleInput:async e=>{let{selectParams:t}=l;t.fuzzyValue=e;let a={invincible:e,openMultipleStores:l.userInfo.openMultipleStores,needNum:0};const i=(await y(a)).map((e=>{let t=e.info;return t.name=e.info.productName,t.productUuid=e.productUuid,t.drugUuid=e.productUuid,t.businessUuid=e.businessUuid,t.onlyUuid=e.businessUuid+e.productUuid,t.oldRetailPrice=e.retailPrice,t.oldMemberPrice=e.memberPrice,t.newMemberPrice="",t.outputTaxRate=e.info.outputTaxRate,t.overallPackPrice=e.overallPackPrice,t.overallPackNum=e.overallPackNum,t.unit=e.info.unit,t.deleavePackNum=e.deleavePackNum,t.splitUnit=e.info.splitUnit,t}));s.selectArr=i},handleChange:e=>{l.data.push(w.cloneDeep(e)),l.pot=l.data.length-1,s.batchObject.productUuid=e.productUuid,l.pagination.page=Math.ceil(l.data.length/l.pagination.size);let t=l.data.length%l.pagination.size;l.pot=t?t-1:l.pagination.size-1,s.selectArr=[]},handleSubmit:async e=>{let{info:t,data:a,editForm:r,editForm1:o,baseTable:d}=l,u=!0;if(u=r.handleClick(e),o&&(u=o.handleClick(e)),!u)return!1;if(!a.length)return v.warning({message:"请添加商品信息",type:"warning"}),!1;if(a.length&&(u=d.verification()),!u)return!1;let p="edit"==s.status?j:k;await p({createTime:t.createTime,creator:t.creator,adjustPriceDetails:a,note:t.note,number:t.number,uuid:s.uuid?s.uuid:"",businessUuid:t.businessUuid,business:t.business,state:"edit"==s.status?1:0,openMultipleStores:C(i.info.bind({$store:n})).value.openMultipleStores}),l.close=!0},batchHandleInput:async e=>{s.batchObject.batchNum=e},onHandleTableChange:o,clearMsg:()=>{s.selectArr=[]},delTable:t=>{if("see"==e.query.type)return;let a=l.pagination.page-1;a=a*l.pagination.size+t,l.data.splice(a,1),l.pot=t},handlcurrentChange:e=>{l.pagination.page=e},handlSizeChange:e=>{l.pagination.size=e}}));var p}};const A=(e=>($("data-v-ace8dec4"),e=e(),F(),e))((()=>q("div",{class:"title"},"商品调价详情",-1))),L={key:0},E=U(" 完成 "),H={class:"top-content"},W={class:"main"},K={class:"block"};var G=V(B,[["render",function(e,t,a,i,n,s){const l=o,r=d,b=u,h=p,f=T("el-pagination"),g=c,y=m;return I(),S(y,{backTips:"see"!==e.status,close:e.close,route:e.go,"t-id":"tab"},{header:R((()=>[A,"see"!==e.status?(I(),D("div",L,[M(l,{config:e.config,onClick:t[0]||(t[0]=e=>i.handleSubmit(!0))},{default:R((()=>[E])),_:1},8,["config"])])):O("",!0)])),top:R((()=>[q("div",H,[M(r,{ref:"editForm","form-data":e.formInfo,"onUpdate:form-data":t[1]||(t[1]=t=>e.formInfo=t),"submit-form":e.info,"onUpdate:submit-form":t[2]||(t[2]=t=>e.info=t)},null,8,["form-data","submit-form"])])])),default:R((()=>[M(g,{ref:"keyBoard",data:e.data.slice((e.pagination.page-1)*e.pagination.size,(e.pagination.page-1)*e.pagination.size+e.pagination.size),down:[".main .select-table .el-table__body-wrapper .el-table__row"],pot:e.pot,range:[0,1,2],first:".main .select-input"},{default:R((()=>[q("div",W,[M(b,{ref:"baseTable",pageList:e.pagination,"onUpdate:pageList":t[3]||(t[3]=t=>e.pagination=t),columns:"see"===e.status?e.columns1:e.columns,delTable:i.delTable,"fixed-head":!1,"option-show":!1,"reduce-num":70,"table-data":e.data.slice((e.pagination.page-1)*e.pagination.size,(e.pagination.page-1)*e.pagination.size+e.pagination.size),"table-data-sum":e.data,class:"select-table","class-id":"tab",onDel:i.delTable},null,8,["pageList","columns","delTable","table-data","table-data-sum","onDel"]),M(h,{ref:"selectTable",disabled:"see"==e.status,head:e.batchHeader,keys:e.keys,options:e.selectArr,"onUpdate:options":t[4]||(t[4]=t=>e.selectArr=t),props:{label:"name",value:"onlyUuid"},class:"select-input",placeholder:"请输入商品编码/助记码/商品名称/条码",onClear:i.clearMsg,onOnInput:i.handleInput,onOnChange:i.handleChange},null,8,["disabled","head","keys","options","onClear","onOnInput","onOnChange"]),q("div",K,[M(f,{"current-page":e.pagination.page,"page-size":e.pagination.size,"page-sizes":[10,20,50,100],total:e.data.length,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:i.handlcurrentChange,onSizeChange:i.handlSizeChange},null,8,["current-page","page-size","total","onCurrentChange","onSizeChange"])])])])),_:1},8,["data","down","pot"])])),_:1},8,["backTips","close","route"])}],["__scopeId","data-v-ace8dec4"]]);export{G as default};
