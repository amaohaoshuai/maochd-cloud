var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,o=(e,t)=>{for(var a in t||(t={}))r.call(t,a)&&l(e,a,t[a]);if(i)for(var a of i(t))s.call(t,a)&&l(e,a,t[a]);return e},u=(e,i)=>t(e,a(i));import{_ as n}from"./SubmitButton.99d990fd.js";import{_ as m}from"./EditForm.8c35f1a6.js";import{_ as d}from"./BaseTable.36f55649.js";import{_ as p}from"./SelectTable.80e1f2f6.js";import{_ as c}from"./KeyBoard.96ba8d0b.js";import{_ as b}from"./BaseForm.bc55ad6b.js";import{_ as h}from"./BaseCard.46de0c24.js";import{_ as f}from"./BaseName.1aa32b4b.js";import{u as g}from"./vuex.c868d4e0.js";import{b as y}from"./vue-router.91336ba9.js";import{j as N}from"./index.1eb722f1.js";import{r as x,_ as U}from"./index.ab904951.js";import{b as k,f as F,c as w,q as D,d as v}from"./index.11e7499a.js";import{_ as j}from"./lodash.d7ab6f48.js";import{b as P,_ as C}from"./element-plus.b44d97a8.js";import{a as _}from"./businessRule.60794e55.js";import{j as B,e as V,B as T,S as A,Y as I,h as z,D as S,i as O,t as E,L as R,o as q,c as L,w as H,a6 as K,v as W,z as $,J as M,a9 as G,aa as J}from"./@vue.23a4bd1a.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./dayjs.bad04745.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";var Y={name:"AddPurchaseReturn",setup(){let e=y(),t=g(),{dict:a}=t.state.common,i=B({supplier:[],mechanism:[],selectArr:[],reason:a.find((e=>"returnReason"===e.key)).data}),r=B({batchObject:{productUuid:"",batchNum:""},batchKeys:["batchNumIn","batchNum","productionDate","expireDate","overallPackNum"],batchHeader:["批次","批号","生产日期","有效期至","整装库存数量"],batchNumberIn:{},batchProps:{label:"batchNumIn",value:"batchNumIn"},top:{"margin-top":"5px"},design:{width:"220px",height:"40px"}}),s=B({isDetail:!1,keyList:["productName","specification","unit","manufacturer"],loading:!1,currentObj:null,formConfig:{"highlight-current-row":!0},selectForm:null,tableData2:[],extractVisible:!1,formData2:{inline:!0,labelWidth:"82px",config:{size:"medium"},list:[{label:"门店",require:!0,type:"SELECT",props:{label:"name",value:"uuid"},disabled:()=>!0,list:()=>i.mechanism,key:"businessUuid"},{label:"供应商名称",require:!0,type:"SELECT",props:{label:"supplierName",value:"supplierUuid"},list:()=>i.supplier,key:"supplierUuid"},{type:"INPUT",placeholder:"退货单编号",label:"退货单编号",key:"orderNo"}]},submitForm1:{"page.currentPage":1,"page.pageSize":10,isFirst:0,source:"TH"},columns2:[{type:"index",title:"序号",formConfig:{width:50},fixed:"left"},{title:"冲红单编号",key:"rushNo",width:140},{title:"退货单编号",key:"orderNo",width:135,render:e=>[V(T("el-button"),{type:"text",onClick:t=>{q(e)}},{default:()=>[e.orderNo]})]},{title:"供应商名称",key:"supplierName",width:78},{title:"商品种类",key:"category1",align:"right"},{title:"数量",key:"rushNum",align:"right"},{title:"含税金额合计",key:"totalAmountTax",align:"right"},{title:"金额合计",key:"totalAmount",align:"right"},{title:"创建人",key:"createUser"},{title:"制单时间",key:"planDate",width:180}],isFlag:!0,oldBusiness:[],supplierUuid:"",dialogVisible:!1,keyBoard:null,baseTable:null,editForm:null,tabClose:!1,keys:["code","name","dosageForm","specification","manufacturer"],pot:-1,selectParams:{fuzzyValue:"",businessUuid:"",supplierUuid:"",batchNum:"",productUuid:""},formData:{inline:!0,labelWidth:"84px",list:[{label:"退货单编号",key:"returnNo",span:8,type:"DIV"},{label:"创建人",key:"createUser",span:8,type:"DIV"},{label:"门店",require:!0,type:"SELECT",span:8,props:{label:"name",value:"uuid"},disabled:()=>!!s.isDetail,config:{onChange:e=>{0==s.tableData.length&&(s.oldBusiness=s.submitForm.businessUuid),h(),s.tableData.length>0&&P.confirm("切换当前门店会清空数据!","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{s.tableData=[],s.oldBusiness=s.submitForm.businessUuid,h()})).catch((()=>{s.submitForm.businessUuid&&(s.submitForm.businessUuid=s.oldBusiness)}))}},list:()=>i.mechanism,key:"businessUuid"},{label:"供应商名称",require:!0,span:8,type:"SELECT",props:{label:"supplierName",value:"supplierUuid"},list:()=>i.supplier,disabled:()=>!!s.isDetail,config:{onChange:e=>{s.tableData.length&&P.confirm("此操作将清空所选商品信息, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",beforeClose:(e,t,a)=>{"confirm"===e?(s.tableData=[],a()):(s.submitForm.supplierUuid=s.supplierUuid,a())}}).catch((e=>e))}},key:"supplierUuid"},{label:"采购员",require:!0,span:8,type:"SELECT",list:()=>i.people,disabled:()=>!!s.isDetail,props:{label:"userName",value:"userName"},key:"purchaseUser"},{label:"备注",type:"INPUT",key:"remark",placeholder:"请输入，不超过100字",disabled:()=>!!s.isDetail,span:10,inputType:"textarea",design:{width:100},config:{showWordLimit:!0,maxlength:100,autosize:{minRows:2}}}]},submitForm:{createUser:t.state.common.info.userName},tableData:[],columns:[{title:"序号",type:"index",fixed:"left",formConfig:{width:50}},{title:"商品编码",key:"code",width:150,fixed:"left"},{title:"商品名称/规格/单位/生产厂家",width:300,fixed:"left",render:e=>V(f,{isShow:2===e.pickState,row:e,list:s.keyList},null)},{title:"批次",key:"batchNumIn",formConfig:{"show-overflow-tooltip":!1},width:250,require:!0,header:()=>V("div",{class:"table-title"},[V("i",null,[A("*")]),A("批次")]),render:(e,t,a,i)=>V(p,{class:e[`batchNumIn_${i}`],keys:r.batchKeys,placeholder:"请输入",design:r.design,head:r.batchHeader,icon:!1,options:r.batchNumberIn[e.productUuid],props:r.batchProps,top:r.top,onOnChange:t=>{c(t,e,i)},config:{filterable:!1,remote:!1,size:"mini",modelValue:e.batchNumIn||void 0,disabled:!!s.isDetail}},null)},{title:"批号",key:"batchNum",width:200},{title:"生产日期",key:"productionDate",width:150},{title:"有效期至",key:"expireDate",width:150},{title:"库存数量",key:"overallPackNum",width:150},{title:"退货数量",require:!0,formConfig:{"show-overflow-tooltip":!1},header:()=>V("div",{class:"table-title"},[V("i",null,[A("*")]),A("退货数量")]),key:"returnNum",width:220,render:(e,t,a,i)=>V(T("el-input-number"),{size:"mini",step:1e-6,stepStrictly:!0,class:e[`returnNum_${i}`],min:0,placeholder:"请输入",disabled:s.isDetail,modelValue:e.returnNum||void 0,onChange:t=>{n(e,"returnNum",t),m(e)}},null)},{title:"退货原因",key:"reason",width:150,formConfig:{"show-overflow-tooltip":!1},render:(e,t,a,r)=>{let l;return V(T("el-select"),{size:"mini",class:e[`reason_${r}`],modelValue:e.reason,placeholder:"请选择",disabled:!!s.isDetail,onChange:t=>{n(e,"reason",t)}},"function"==typeof(o=l=i.reason.map((e=>V(T("el-option"),{key:e.key,label:e.key,value:e.key},null))))||"[object Object]"===Object.prototype.toString.call(o)&&!I(o)?l:{default:()=>[l]});var o}},{title:"含税进价",key:"taxPaid",width:150,align:"right"},{title:"进价",key:"price",width:150,align:"right"},{title:"含税金额",key:"taxAmount",width:150,align:"right",render:e=>e.taxPaid&&e.returnNum?(e.taxAmount=(e.taxPaid*e.returnNum).toFixed(2),(e.taxPaid*e.returnNum).toFixed(2)):(e.taxAmount=null,"-")},{title:"金额",key:"amount",width:150,align:"right",render:e=>e.price&&e.returnNum?(e.amount=(e.price*e.returnNum).toFixed(2),(e.price*e.returnNum).toFixed(2)):(e.amount=null,"-")},{title:"税额",key:"tax",width:150,align:"right",render:e=>e.taxPaid&&e.returnNum&&e.price?(e.tax=((e.taxPaid-e.price)*e.returnNum).toFixed(2),((e.taxPaid-e.price)*e.returnNum).toFixed(2)):(e.tax=null,"-")},{title:"零售价",key:"retailPrice",width:150,align:"right"},{title:"零售金额",key:"retailAmount",width:150,align:"right",render:e=>e.retailPrice&&e.returnNum?(e.retailAmount=(e.retailPrice*e.returnNum).toFixed(2),(e.retailPrice*e.returnNum).toFixed(2)):(e.retailAmount=null,"-")},{title:"进项税率(%)",key:"inputTaxRate",width:150,align:"right"},{title:"批准文号",key:"approvalNumber",width:224},{title:"上市许可持有人",key:"holderPermit",width:170},{title:"柜组",key:"cabinetGroupName",width:100},{title:"操作",key:"options",fixed:"right",hidden:()=>s.isDetail,width:150,render:(e,t,a,i)=>V(T("el-button"),{type:"text",class:"delete",disabled:!!s.isDetail,onClick:()=>{s.tableData.splice(i,1),s.pot=i}},{default:()=>[A("删除")]})}]});const l=z((()=>{let e={code:j.uniqBy(s.tableData,"code").length,returnNum:0,taxAmount:0,amount:0,retailAmount:0};return s.tableData.forEach((t=>{let{returnNum:a,taxAmount:i,amount:r,retailAmount:s}=t;e.returnNum+=parseFloat(a||0,10),e.taxAmount+=parseFloat(i||0,10),e.amount+=parseFloat(r||0,10),e.retailAmount+=parseFloat(s||0,10)})),e})),n=(e,t,a)=>{e[t]=a},m=e=>{0===e.returnNum&&P.alert("退货数量不能为0",{confirmButtonText:"我知道了",callback:t=>{e.returnNum=void 0}}),e.returnNum>e.overallPackNum&&P.alert("退货数量不能大于现有库存数量",{confirmButtonText:"我知道了",callback:t=>{e.returnNum=void 0}});let{array:t,index:a}=s.keyBoard;t[s.keyBoard.index].focus()},d=async()=>{const e=await F(s.selectParams);r.batchNumberIn[s.selectParams.productUuid]=e,s.selectParams.productUuid="",s.selectParams.batchNum="",s.selectParams.fuzzyValue=""},c=(e,t,a)=>{if(e){s.tableData.filter(((e,t)=>t!==a)).some((t=>t.batchNumIn===e.batchNumIn&&t.productUuid===e.productUuid))?(C.warning("批次号不能重复选择!"),t.batchNumIn=void 0):t.batchNumIn=e.batchNumIn,t.returnNum=void 0,t=Object.assign(t,{batchNum:e.batchNum,productionDate:e.productionDate,expireDate:e.expireDate,taxPaid:e.taxPaid,overallPackNum:e.overallPackNum,price:e.price,approvalNumber:e.approvalNumber,inputTaxRate:e.inputTaxRate,holderPermit:e.holderPermit,retailPrice:e.retailPrice})}},b=()=>{P.confirm("请选择门店后,再进行操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{s.isFlag=!0})).catch((()=>{s.isFlag=!0}))},h=async()=>{i.people=await t.dispatch("common/selectByStation",{stationName:2,businessUuid:s.oldBusiness}),i.people.length>0?(s.purchaseUser=i.people[0].userName,s.submitForm.purchaseUser=i.people[0].userName):(s.purchaseUser="123",s.submitForm.purchaseUser="")},U=async()=>{s.storeUuid=e.query.uuid,w({uuid:s.storeUuid}).then((e=>{s.info=e,s.submitForm.businessUuid=e.businessUuid,s.submitForm.purchaseUser=e.purchaseUser,s.submitForm.supplierUuid=e.supplierUuid,s.submitForm.returnNo=e.returnNo,s.submitForm.remark=e.remark,s.tableData=e.detail}))};S((async()=>{s.isDetail=!!e.query.isDetail,s.storeUuid!==e.query.uuid&&U(),i.mechanism.length||(i.mechanism=await t.dispatch("common/mechanism"),_(s.submitForm,i.mechanism),s.oldBusiness=s.submitForm.businessUuid,i.supplier=await N(),i.people=await t.dispatch("common/selectByStation",{stationName:2,businessUuid:s.oldBusiness}),s.submitForm.purchaseUser&&(s.submitForm.purchaseUser=i.people[0].userName),s.submitForm.createUser=t.state.common.info.userName,1==i.mechanism.length&&(s.submitForm.purchaseUser=i.people[0].userName))}));const R=()=>{D(s.submitForm1).then((e=>{s.tableData2=e.list,s.submitForm1.total=e.totalCount}))},q=e=>{x.push({name:"PurchaseReturnDetail",query:{uuid:e.sourceUuid,returnPath:"/purchase/rush-red"}})};return O((()=>s.submitForm.supplierUuid),((e,t)=>{e&&(s.supplierUuid=t)})),u(o(o(o({},E(r)),E(i)),E(s)),{cancelSubmit:()=>{s.tabClose=!0},handleSubmit:()=>{if(!s.submitForm.businessUuid)return void b();let{tableData:e,editForm:t,baseTable:a}=s,i=!0;return i=t.handleClick(!0),e.length?(e.length&&(i=a.verification()),!!i&&void(s.dialogVisible=!s.dialogVisible)):(C.warning({message:"请添加商品信息",type:"warning"}),!1)},handleInput:async e=>{if(!e)return void(i.selectArr=[]);let{selectParams:t}=s;t.fuzzyValue=e,t.businessUuid=s.submitForm.businessUuid,t.supplierUuid=s.submitForm.supplierUuid;let a=await F(t);a.forEach((e=>{e.name=e.productName})),i.selectArr=a},handleChange:e=>{j.find(s.tableData,{code:e.code})&&(e.returnNum=void 0),s.tableData.push(j.cloneDeep(e)),s.selectParams.productUuid=e.productUuid,s.selectParams.batchNum=e.batchNum,s.selectParams.fuzzyValue="",s.pot=s.tableData.length-1,i.selectArr=[],d()},submitPurchaseReturn:()=>{s.dialogVisible=!s.dialogVisible;let e=u(o({},s.submitForm),{detail:s.tableData});k(e).then((e=>{s.tabClose=!0}))},batchHandleChange:c,getBatchList:d,totalNum:l,clearMsg:()=>{i.selectArr=[]},submitTips:b,getSupplier:h,extract:()=>{s.submitForm.businessUuid?(s.submitForm1.businessUuid=s.submitForm.businessUuid,s.extractVisible=!0,R()):b()},getList:R,handleClose:()=>{s.selectForm.handleRest(!1),s.extractVisible=!1},currentRow:e=>{s.currentObj=e},handleSubmit2:()=>{s.currentObj?(s.loading=!0,v(s.currentObj.uuid).then((async e=>{s.tableData=e.details,s.submitForm.businessUuid=e.businessUuid,s.submitForm.purchaseUser=e.purchaseUser,s.submitForm.supplierUuid=e.supplierUuid,s.submitForm.remark=e.remark,s.extractVisible=!1;let{selectParams:t}=statex;t.businessUuid=e.businessUuid,t.supplierUuid=e.supplierUuid;for(let a=0;a<e.details.length;a++){t.productUuid=e.details[a].productUuid;let i=await F(t);i.forEach((e=>{e.name=e.productName})),r.batchNumberIn[s.selectParams.productUuid]=i}})).finally((()=>{s.loading=!1}))):C.warning({message:"还未选择商品！",type:"warning"})},getDetails:q,initData:U})}};const Q=e=>(G("data-v-1790346a"),e=e(),J(),e),X=Q((()=>K("span",{style:{"font-size":"16px","font-weight":"700"}},"采购退货单详情",-1))),Z=A(" 完成 "),ee={class:"top-content"},te={class:"main",style:{position:"relative"}},ae={class:"getInfo"},ie={class:"text"},re=A(" 提取冲红单 "),se={class:"confirmDialog"},le=Q((()=>K("p",{style:{"margin-bottom":"30px"}},[K("i",{class:"el-icon-warning"}),A(" 确认退货吗？ ")],-1))),oe=A(" 退货商品种类合计： "),ue=A(" 退货商品数量合计： "),ne=A(" 退货金额合计： "),me=A(" 退货含税金额合计： "),de=A(" 退货零售金额合计： "),pe=Q((()=>K("p",{class:"tips"},"注：完成后系统自动调整库存数量和库存金额",-1))),ce=A("取 消"),be=A(" 退 货 "),he={class:"dialog-footer"},fe=A("取 消"),ge=A(" 确 定 ");var ye=U(Y,[["render",function(e,t,a,i,r,s){const l=n,o=m,u=d,f=p,g=T("el-button"),y=c,N=T("el-dialog"),x=b,U=h,k=R("loading");return q(),L(U,{close:e.tabClose,route:{path:"/purchase/purchase-return"},"t-id":"tab"},{header:H((()=>[X,K("div",null,[e.isDetail?W("",!0):(q(),L(l,{key:0,class:"btn",config:{size:"small"},onClick:i.handleSubmit},{default:H((()=>[Z])),_:1},8,["onClick"]))])])),top:H((()=>[K("div",ee,[V(o,{"form-data":e.formData,"onUpdate:form-data":t[0]||(t[0]=t=>e.formData=t),"submit-form":e.submitForm,"onUpdate:submit-form":t[1]||(t[1]=t=>e.submitForm=t),style:{"margin-top":"22px"},ref:"editForm"},null,8,["form-data","submit-form"])])])),default:H((()=>[V(y,{ref:"keyBoard",data:e.tableData,down:[".main .select-table .el-table__body-wrapper  .el-table__row"],range:[0,1],first:".main .select-input",pot:e.pot},{default:H((()=>[K("div",te,[V(u,{class:"select-table",columns:e.columns,"table-data":e.tableData,"fixed-head":!1,options:!1,ref:"baseTable","reduce-num":100,"class-id":"tab"},{buttons:H((()=>[K("div",ae,[K("div",ie,[K("span",null,"商品种类合计："+$(i.totalNum.code.toFixed(0)),1),K("span",null,"退货数量合计："+$(i.totalNum.returnNum.toFixed(6)),1),K("span",null,"含税金额合计："+$(i.totalNum.taxAmount.toFixed(2))+"元",1),K("span",null,"金额合计："+$(i.totalNum.amount.toFixed(2))+"元",1),K("span",null," 零售金额合计："+$(i.totalNum.retailAmount.toFixed(2))+"元 ",1)])])])),_:1},8,["columns","table-data"]),V(f,{class:"select-input",keys:e.keys,options:e.selectArr,"onUpdate:options":t[2]||(t[2]=t=>e.selectArr=t),tableData:e.tableData,placeholder:"请输入商品编码/助记码/商品名称/条码",onOnInput:i.handleInput,onOnChange:i.handleChange,onClear:i.clearMsg,ifDis:!1,props:{label:"userName",value:"productUuid"},config:{disabled:!(e.submitForm.supplierUuid&&e.submitForm.businessUuid&&!e.isDetail)}},null,8,["keys","options","tableData","onOnInput","onOnChange","onClear","config"]),e.isDetail?W("",!0):(q(),L(g,{key:0,size:"small",type:"primary",style:{position:"absolute",left:"400px",bottom:"0px"},onClick:i.extract},{default:H((()=>[re])),_:1},8,["onClick"]))])])),_:1},8,["data","down","pot"]),V(N,{title:"退货",modelValue:e.dialogVisible,"onUpdate:modelValue":t[4]||(t[4]=t=>e.dialogVisible=t),width:"30%"},{footer:H((()=>[V(g,{onClick:t[3]||(t[3]=t=>e.dialogVisible=!1)},{default:H((()=>[ce])),_:1}),V(g,{type:"primary",onClick:i.submitPurchaseReturn},{default:H((()=>[be])),_:1},8,["onClick"])])),default:H((()=>[K("div",se,[le,K("p",null,[oe,K("span",null,$(i.totalNum.code.toFixed(0)),1)]),K("p",null,[ue,K("span",null,$(i.totalNum.returnNum.toFixed(6)),1)]),K("p",null,[ne,K("span",null,$(i.totalNum.amount.toFixed(2)),1)]),K("p",null,[me,K("span",null,$(i.totalNum.taxAmount.toFixed(2)),1)]),K("p",null,[de,K("span",null,$(i.totalNum.retailAmount.toFixed(2)),1)]),pe])])),_:1},8,["modelValue"]),V(N,{title:"请选择退货冲红单",modelValue:e.extractVisible,"onUpdate:modelValue":t[7]||(t[7]=t=>e.extractVisible=t),width:"1200px","before-close":i.handleClose},{footer:H((()=>[K("span",he,[V(g,{onClick:i.handleClose,size:"small"},{default:H((()=>[fe])),_:1},8,["onClick"]),M(V(g,{type:"primary",onClick:t[6]||(t[6]=e=>i.handleSubmit2()),size:"small"},{default:H((()=>[ge])),_:1},512),[[k,e.loading]])])])),default:H((()=>[V(x,{"form-data":e.formData2,options:!0,"submit-form":e.submitForm1,"onUpdate:submit-form":t[5]||(t[5]=t=>e.submitForm1=t),select:i.getList,ref:"selectForm"},null,8,["form-data","submit-form","select"]),V(u,{maxHeight:385,"table-data":e.tableData2,pagination:e.submitForm1,columns:e.columns2,select:i.getList,optionShow:!1,formConfig:e.formConfig,currentRow:i.currentRow},null,8,["table-data","pagination","columns","select","formConfig","currentRow"])])),_:1},8,["modelValue","before-close"])])),_:1},8,["close"])}],["__scopeId","data-v-1790346a"]]);export{ye as default};
