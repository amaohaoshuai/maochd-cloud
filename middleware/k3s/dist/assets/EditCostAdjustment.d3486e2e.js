var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,r=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,l=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&r(e,a,t[a]);if(s)for(var a of s(t))o.call(t,a)&&r(e,a,t[a]);return e};import{_ as n}from"./SubmitButton.99d990fd.js";import{_ as d}from"./EditForm.8c35f1a6.js";import{_ as u}from"./BaseTable.36f55649.js";import{_ as m}from"./SelectTable.80e1f2f6.js";import{_ as b}from"./KeyBoard.96ba8d0b.js";import{_ as c}from"./BaseCard.46de0c24.js";import{_ as p}from"./BaseName.1aa32b4b.js";import{u as f}from"./vuex.c868d4e0.js";import{b as h,u as g}from"./vue-router.91336ba9.js";import{a as y}from"./businessRule.60794e55.js";import{a as v,u as w,i as j,b as C}from"./index.85dcfec4.js";import{_ as k}from"./lodash.d7ab6f48.js";import{b as D,_ as F}from"./element-plus.b44d97a8.js";import{j as U,e as x,S as N,B as P,D as _,t as B,o as T,c as E,w as O,a6 as A,a9 as z,aa as q}from"./@vue.23a4bd1a.js";import{_ as S}from"./index.ab904951.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";var I={name:"EditCostAdjustment",setup(){let e=h();g();let s=f(),i=U({mechanism:[],selectArr:[]}),o=U({isEdit:!1,isFlag:!0,isDisabled:!1,btnDisabled:!1,queryUuid:"",keyBoard:null,baseTable:null,editForm:null,tabClose:!1,loading:!1,pagination:{page:1,size:1e4},keys:["productCode","productName","specification","unit","manufacturer","retailPrice","barCode"],pot:-1,selectParams:{invincible:"",businessUuid:"",isAbnormal:0},formData:{inline:!0,labelWidth:"84px",span:6,list:[{label:"门店",require:!0,type:"SELECT",props:{label:"name",value:"uuid"},list:()=>i.mechanism,key:"businessUuid",config:{onChange:e=>{o.isDisabled=!1,0==o.tableData.length&&(o.oldBusiness=o.submitForm.businessUuid),o.tableData.length>0&&D.confirm("切换当前门店会清空数据!","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{o.tableData=[],o.oldBusiness=o.submitForm.businessUuid,o.isDisabled=!1,o.btnDisabled=!1})).catch((()=>{o.submitForm.businessUuid&&(o.submitForm.businessUuid=o.oldBusiness),o.isDisabled=!0,o.btnDisabled=!0}))}}},{label:"备注",type:"INPUT",key:"remark",design:{width:"200px"},placeholder:"请输入，不超过100字",inputType:"textarea",config:{showWordLimit:!1,maxlength:100,autosize:{minRows:1}}}]},submitForm:{businessUuid:[],remark:""},tableData:[],columns:[{title:"序号",type:"index",fixed:"left",formConfig:{width:50}},{title:"商品编码",key:"productCode",width:150,fixed:"left"},{title:"商品名称/规格/单位/生产厂家",width:300,fixed:"left",render:e=>x(p,{row:e,list:["name","specification","unit","manufacturer"]},null)},{title:"库存数量",key:"overallPackNum",width:100,render:e=>`${(e.overallPackNum||0===e.overallPackNum?e.overallPackNum+e.unit:" ")+(e.deleavePackNum?e.deleavePackNum+e.splitUnit:" ")}`},{title:"原成本单价",key:"oldCost",width:100,align:"right"},{title:"新成本单价",require:!0,formConfig:{"show-overflow-tooltip":!1},header:()=>x("div",{class:"table-title"},[x("i",null,[N("*")]),N(" 新成本单价")]),key:"newCost",width:120,render:(e,t,a,s)=>x(P("el-input-number"),{size:"mini",step:1e-6,stepStrictly:!0,class:e[`newCost_${s}`],min:1e-6,max:99999999,placeholder:"请输入",modelValue:e.newCost||void 0,onChange:t=>{r(e,"newCost",t),n(e)}},null)},{title:"成本单价差价",key:"costDiff",width:120,align:"right",render:e=>e.newCost?parseFloat(Number(e.newCost)-Number(e.oldCost)).toFixed(6):"-"},{title:"原库存金额",key:"oldTotalCost",width:100,align:"right"},{title:"新库存金额",key:"newTotalCost",width:100,align:"right",render:e=>e.newCost?parseFloat(Number(e.newCost)*Number(e.overallPackNum)+Number(e.newCost)/Number(e.conversionRatio)*Number(e.deleavePackNum)).toFixed(2):"-"},{title:"库存金额差额",key:"",width:120,align:"right",render:e=>e.newCost?parseFloat(parseFloat(Number(e.newCost)*Number(e.overallPackNum)+Number(e.newCost)/Number(e.conversionRatio)*Number(e.deleavePackNum)).toFixed(2)-Number(e.oldTotalCost)).toFixed(6):"-"},{title:"毛利率",key:"grossMargin",width:100,align:"right"},{title:"操作",key:"options",fixed:"right",width:150,render:(e,t,a,s)=>x(P("el-button"),{type:"text",class:"delete",onClick:()=>{o.tableData.splice(s,1),o.pot=s}},{default:()=>[N("删除")]})}]});const r=(e,t,a)=>{e[t]=a},n=e=>{0===e.newCost&&D.alert("新成本单价不能为0",{confirmButtonText:"我知道了",callback:t=>{e.newCost=void 0}});let{array:t,index:a}=o.keyBoard;t[o.keyBoard.index].focus()},d=k.debounce((async e=>{if(o.isFlag){if(!o.submitForm.businessUuid)return void u();if(!e)return void(i.selectArr=[]);let{selectParams:t}=o;t.invincible=e,t.isAbnormal=0,t.businessUuid=o.submitForm.businessUuid;let a=await v(t);i.selectArr=a,o.submitForm.businessUuid||(o.isFlag=!1)}}),500),u=()=>{D.confirm("请选择门店后,再进行操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{o.isFlag=!0})).catch((()=>{o.isFlag=!0}))};_((async()=>{let{query:t}=e;var a;o.isEdit=t.isEdit,t.uuid&&(o.queryUuid=t.uuid,a=t.uuid,C({uuid:a}).then((e=>{o.submitForm.businessUuid=e.businessUuid,o.submitForm.remark=e.remark,e.adjustCostDetailVos.forEach((e=>{e.name=e.productName})),o.tableData=e.adjustCostDetailVos}))),i.mechanism.length||(i.mechanism=await s.dispatch("common/mechanism"),y(o.submitForm,i.mechanism))}));return m=l(l({},B(i)),B(o)),t(m,a({handleSubmit:()=>{if(!o.submitForm.businessUuid)return void u();let{tableData:e,editForm:t,baseTable:a,submitForm:s}=o,i=!0;if(i=t.handleClick(!0),!e.length)return F.warning({message:"请添加商品信息",type:"warning"}),!1;if(e.length&&(i=a.verification()),!i)return!1;let r={adjustCostDetailForms:e,businessUuid:s.businessUuid,uuid:o.queryUuid,state:0};o.queryUuid?w(r).then((e=>{o.tabClose=!0})):j(r).then((e=>{o.tabClose=!0}))},handleInput:d,handleChange:e=>{e.name=e.productName,k.find(o.tableData,{code:e.code})&&(e.newCost=void 0),o.tableData.push(k.cloneDeep(e)),o.selectParams.invincible="",o.pot=o.tableData.length-1,i.selectArr=[]},clearMsg:()=>{i.selectArr=[]},getErrorList:()=>{o.submitForm.businessUuid?(o.loading=!0,o.selectParams.invincible="",o.selectParams.isAbnormal=1,o.submitForm.businessUuid,o.selectParams.businessUuid=o.submitForm.businessUuid,v(o.selectParams).then((e=>{o.loading=!1,o.btnDisabled=!0,e&&(e.forEach((e=>{e.name=e.productName})),o.tableData=[...o.tableData,...e],o.tableData=k.uniqBy(o.tableData,"productUuid"))})).catch((e=>{o.loading=!1,o.btnDisabled=!0}))):u()}}));var m}};const L=(e=>(z("data-v-2c11a720"),e=e(),q(),e))((()=>A("span",{style:{"font-size":"16px","font-weight":"700"}}," 成本调整单详情 ",-1))),R=N(" 完成 "),M={class:"top-content"},V={class:"main"},K=N(" 异常成本提取单 ");var W=S(I,[["render",function(e,t,a,s,i,o){const r=n,l=d,p=P("el-button"),f=u,h=m,g=b,y=c;return T(),E(y,{close:e.tabClose,route:{path:"/commodity-manage/cost-adjustment"}},{header:O((()=>[L,A("div",null,[x(r,{class:"btn",config:{size:"small"},onClick:s.handleSubmit},{default:O((()=>[R])),_:1},8,["onClick"])])])),top:O((()=>[A("div",M,[x(l,{"form-data":e.formData,"onUpdate:form-data":t[0]||(t[0]=t=>e.formData=t),"submit-form":e.submitForm,"onUpdate:submit-form":t[1]||(t[1]=t=>e.submitForm=t),style:{"margin-top":"22px"},ref:"editForm"},null,8,["form-data","submit-form"])])])),default:O((()=>[x(g,{ref:"keyBoard",data:e.tableData,down:[".main .select-table .el-table__body-wrapper  .el-table__row"],range:[0,1],first:".main .select-input",pot:e.pot},{default:O((()=>[A("div",V,[x(f,{class:"select-table",columns:e.columns,"table-data":e.tableData,"fixed-head":!1,options:!1,ref:"baseTable",pageList:e.pagination,"onUpdate:pageList":t[2]||(t[2]=t=>e.pagination=t),disabled:e.isEdit},{buttons:O((()=>[x(p,{type:"primary",size:"small",disabled:e.btnDisabled,onClick:s.getErrorList,loading:e.loading},{default:O((()=>[K])),_:1},8,["disabled","onClick","loading"])])),_:1},8,["columns","table-data","pageList","disabled"]),x(h,{class:"select-input",keys:e.keys,options:e.selectArr,"onUpdate:options":t[3]||(t[3]=t=>e.selectArr=t),tableData:e.tableData,disabledKey:"productUuid",head:["编码","商品名称","规格","单位","生产厂家","零售价","条码"],placeholder:"请输入商品编码/助记码/商品名称/条码",onOnInput:s.handleInput,onOnChange:s.handleChange,onClear:s.clearMsg,props:{label:"userName",value:"productUuid"}},null,8,["keys","options","tableData","onOnInput","onOnChange","onClear"])])])),_:1},8,["data","down","pot"])])),_:1},8,["close"])}],["__scopeId","data-v-2c11a720"]]);export{W as default};
