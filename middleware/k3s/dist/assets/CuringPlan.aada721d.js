var e=Object.defineProperty,t=Object.defineProperties,l=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(t,l,a)=>l in t?e(t,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[l]=a,i=(e,t)=>{for(var l in t||(t={}))r.call(t,l)&&s(e,l,t[l]);if(a)for(var l of a(t))o.call(t,l)&&s(e,l,t[l]);return e};import{_ as u}from"./BaseStencil.46c3d678.js";import{_ as n}from"./BaseDatePicker.831269d5.js";import{s as m,_ as d}from"./index.ab904951.js";import{u as c}from"./vue-router.91336ba9.js";import{a as p}from"./axios.7b768d2b.js";import{_ as f}from"./lodash.d7ab6f48.js";import{b as y}from"./element-plus.b44d97a8.js";import{g as b}from"./index.41a8010a.js";import{s as g,g as h}from"./businessRule.60794e55.js";import{g as v,j as F,e as k,B as T,S as C,D as w,t as j,L as V,o as x,a5 as _,J as P,w as D,a6 as U,F as B,N as L,c as N,z as I,v as S}from"./@vue.23a4bd1a.js";import"./BaseForm.bc55ad6b.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./BaseTable.36f55649.js";import"./sortablejs.621e50ab.js";import"./vuex.c868d4e0.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./moment.08a7f518.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./dayjs.bad04745.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";function q(e){return p.post("/gateway/chain-store/maintenancePlan/insert",e)}function z(e){return p.post("/gateway/chain-store/maintenancePlan/update",e)}function O(e){return p.post("/gateway/chain-store/maintenancePlan/update/state",e)}m.state.common;var Y={name:"CuringPlan",components:{BaseStencil:u},setup(e,s){const u=v([]),n=async(e,t,l)=>{B.title="编辑养护计划";const a=await(r=l.uuid,p.get("/gateway/chain-store/maintenancePlan/find/detail/?uuid="+r));var r;B.uuid=l.uuid,B.ruleForm=a,B.ruleForm.setTask=a.cycle,B.vaild=!0,B.ruleForm.cycle=3==B.ruleForm.cycle||4==B.ruleForm.cycle?3:B.ruleForm.cycle,B.visibility=!0},d=(e,t,l)=>{if(B.statusPopUuid=l.uuid,1==l.state)B.statusVisibility=!0,P.value&&P.value.resetFields();else{let e="此操作禁用养护计划";y.confirm(`${e}, 是否继续?`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",beforeClose:(e,t,a)=>{if("confirm"===e){t.confirmButtonLoading=!0,t.confirmButtonText="执行中...",O({firstTime:"",uuid:l.uuid,state:0==l.state?1:0}).then((e=>{t.confirmButtonLoading=!1,a(),L()}))}else a()}}).catch((e=>e))}},V=(e,t,l)=>{y.confirm("此操作将删除该养护计划,是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",beforeClose:(e,t,a)=>{if("confirm"===e){t.confirmButtonLoading=!0,t.confirmButtonText="执行中...",function(e){return p.post("/gateway/chain-store/maintenancePlan/delete",e)}({uuid:l.uuid}).then((e=>{t.confirmButtonLoading=!1,a(),L()}))}else a()}}).catch((e=>e))},x=v(null),_=v(null),P=v(null),{dict:D}=m.state.common;c();const U=D.length>0?f.find(D,{key:"category1"}):[],B=F({isClear:!1,statusPopUuid:"",vaild:!1,statusVisibility:!1,statusTitle:"启用",uuid:"",formData:{inline:!0,labelWidth:"100px",list:[{placeholder:"请选择门店",type:"SELECT",props:{label:"name",value:"uuid"},list:()=>u.value,key:"businessUuid",config:{multiple:!0}}]},columns:[{type:"index",title:"序号",formConfig:{width:50}},{title:"任务名称",key:"taskName",width:176},{title:"养护类型",key:"mteType",width:100},{title:"门店",key:"business"},{title:"生成周期",key:"cycle"},{title:"商品类型",key:"productType",width:176,render:e=>k("div",null,[e.productType.join(",")])},{title:"养护排序",key:"sortCode"},{title:"首次养护时间",key:"firstTime",width:110},{title:"最后养护时间",key:"lastTime",width:110},{title:"状态",key:"state",render:e=>k("div",null,[0==e.state?"启用":"禁用"])},{title:"创建人",key:"creator"},{title:"最后编辑人",key:"updator"},{title:"操作",key:"c",fixed:"right",width:150,render:(e,t,l,a)=>[k(T("el-button"),{type:"text",onClick:t=>{d(0,0,e)}},{default:()=>[0==e.state?"禁用":"启用"]}),k(T("el-button"),{type:"text",onClick:t=>{n(0,0,e)}},{default:()=>[C("编辑")]}),k(T("el-button"),{style:"color: #F56C6C",type:"text",onClick:t=>{V(0,0,e)}},{default:()=>[C("删除")]})]}],ruleForm:{sortCode:"商品编码",cycle:0,state:0},statusRuleForm:{},rules:{taskName:[{required:!0,message:"请输入任务名称",trigger:"change"}],mteType:[{required:!0,message:"请选择养护类型",trigger:"change"}],businessUuid:[{required:!0,message:"请选择门店",trigger:"change"}],cycle:[{required:!0,message:"请选择生成周期",trigger:"change"}],firstTime:[{required:!0,message:"请输入首次任务时间",trigger:"change"}],productType:[{required:!0,message:"请选择商品类型",trigger:"change"}],sortCode:[{required:!0,message:"请选择养护排序条件",trigger:"change"}],setTask:[{required:!0,message:"请选择任务设置",trigger:"change"}],state:[{required:!0,message:"请选择任务状态",trigger:"change"}],cycleNum:[{required:!0,message:"请输入养护周期",trigger:"change"},{required:!0,pattern:/^[0-9]\d*$/,message:"请输入整数",trigger:"change"}]},statusRules:{firstTime:[{required:!0,message:"请输入任务开始时间",trigger:"change"}]},statusPopInfo:{basePickerConfig:{size:"small",valueFormat:"YYYY-MM-DD",disabledDate:e=>e.getTime()<(new Date).getTime()}},popInfo:{basePickerConfig:{size:"medium",valueFormat:"YYYY-MM-DD",disabledDate:e=>"0"==B.ruleForm.cycle||"1"==B.ruleForm.cycle?e.getTime()<(new Date).getTime():e.getDate()>27||e.getTime()<(new Date).getTime()},sortCodeList:[{label:"商品编码",value:0}],cycType:{0:"天",1:"周",2:"月",3:"季度"},cycleList:[{label:"天",value:0},{label:"周",value:1},{label:"月",value:2},{label:"季度",value:3}],categoryList:U.data,mechanismList:[],curingType:[{label:"一般养护",value:1},{label:"重点养护",value:2},{label:"近效期养护",value:3}]},title:"新增养护计划",visibility:!1,dict:D,otherData:{},tableData:[],loading:!1,submitForm:{"page.currentPage":1,"page.pageSize":10,delFlag:0,businessUuid:[]}}),L=async()=>{B.loading=!0;try{let e=B.submitForm,{businessUuid:t}=e,l=((e,t)=>{var l={};for(var s in e)r.call(e,s)&&t.indexOf(s)<0&&(l[s]=e[s]);if(null!=e&&a)for(var s of a(e))t.indexOf(s)<0&&o.call(e,s)&&(l[s]=e[s]);return l})(e,["businessUuid"]);t=g(t);let s=i({businessUuid:t},l);const u=await function(e){return p.get("/gateway/chain-store/maintenancePlan/find/page",{params:e})}(s);B.submitForm.pageNumber=u.currentPage,B.tableData=u.list,B.submitForm.total=u.totalElements,B.loading=!1}catch(e){return B.loading=!1,e}};w((async()=>{L(),(async()=>{try{const e=await m.dispatch("common/mechanism");B.popInfo.mechanismList=e}catch(e){return e}})(),N(),u.value=await m.dispatch("common/mechanism"),h(u.value,B,B.formData)}));const N=()=>{b().then((e=>{m.commit("common/DICT",e)}))};return I=i({},j(B)),t(I,l({handleStatusClose:e=>{e()},getMaintenancePlanListData:L,form:x,popForm:_,handleClose:e=>{_.value.resetFields(),e()},clear:()=>{_.value.resetFields(),B.visibility=!1},addCuringPlan:()=>{B.visibility=!0,B.uuid="",B.title="新增养护计划",B.ruleForm={sortCode:"商品编码",cycle:0,state:0,setTask:"3",productType:[]},_.value&&_.value.resetFields()},handlePrev:()=>{},handleDetermine:async e=>{try{let e=!1;if(_.value.validate((t=>{e=t})),!e)return;let t=B.uuid?z:q;await t({business:B.ruleForm.business,businessUuid:B.ruleForm.businessUuid,creator:B.ruleForm.creator,cycle:3==B.ruleForm.cycle?B.ruleForm.setTask:B.ruleForm.cycle,cycleNum:B.ruleForm.cycleNum,firstTime:B.ruleForm.firstTime,mteType:B.ruleForm.mteType,productType:B.ruleForm.productType,remark:B.ruleForm.remark,sortCode:B.ruleForm.sortCode,state:B.ruleForm.state,taskName:B.ruleForm.taskName,updator:B.ruleForm.updator,uuid:B.uuid,lastTime:B.uuid?B.ruleForm.lastTime:""}),B.visibility=!1,L()}catch(t){return t}},selectBusiness:e=>{let t=f.find(B.popInfo.mechanismList,{uuid:e});B.ruleForm.business=t.name},detailClick:n,updateStatus:d,deleteClick:V,selectCycle:e=>{B.ruleForm.setTask=e},statusClear:()=>{B.statusVisibility=!1},handleStatusDetermine:()=>{try{let e=!1;if(P.value.validate((t=>{e=t})),!e)return;O({firstTime:B.statusRuleForm.firstTime,state:0,uuid:B.statusPopUuid}).then((e=>{B.statusVisibility=!1,L()}))}catch(e){return e}},popStatusForm:P}));var I}};const R={class:"curing-manage"},M=C("新增养护计划"),E={class:"pop-info"},$={class:"curing-plan-pop"},H={style:{display:"flex"}},J={class:"cycleNumTips"},W=C("单次/季度"),A={key:0,class:"tips"},G=C("启用"),K=C("禁用"),Q={class:"dialog-footer"},X=C("取 消"),Z=C(" 确 定 "),ee={class:"curing-plan-pop-status"},te={class:"dialog-footer1"},le=C("取 消"),ae=C(" 确 定 ");var re=d(Y,[["render",function(e,t,l,a,r,o){const s=T("el-button"),i=u,m=T("el-input"),d=T("el-form-item"),c=T("el-option"),p=T("el-select"),f=T("el-radio"),y=T("el-radio-group"),b=n,g=T("el-form"),h=T("el-dialog"),v=V("loading");return x(),_("div",R,[P(k(i,{"form-data":e.formData,"submit-form":e.submitForm,"onUpdate:submit-form":t[1]||(t[1]=t=>e.submitForm=t),class:"base-stencil","table-data":e.tableData,columns:e.columns,pagination:e.submitForm,draggable:!1,options:!0,"option-show":!1,select:a.getMaintenancePlanListData,ref:"form",isClear:e.isClear},{buttons:D((()=>[k(s,{type:"primary",size:"small",style:{"margin-bottom":"10px"},onClick:t[0]||(t[0]=e=>a.addCuringPlan())},{default:D((()=>[M])),_:1})])),_:1},8,["form-data","submit-form","table-data","columns","pagination","select","isClear"]),[[v,e.loading]]),U("div",E,[k(h,{"before-close":a.handleClose,title:e.title,modelValue:e.visibility,"onUpdate:modelValue":t[12]||(t[12]=t=>e.visibility=t),width:"600px"},{footer:D((()=>[U("span",Q,[k(s,{size:"small",onClick:a.clear},{default:D((()=>[X])),_:1},8,["onClick"]),k(s,{size:"small",type:"primary",onClick:a.handleDetermine},{default:D((()=>[Z])),_:1},8,["onClick"])])])),default:D((()=>[U("div",$,[k(g,{model:e.ruleForm,ref:"popForm",rules:e.rules,"label-width":"110px"},{default:D((()=>[k(d,{label:"任务名称",prop:"taskName"},{default:D((()=>[k(m,{style:{width:"350px"},maxlength:"30",modelValue:e.ruleForm.taskName,"onUpdate:modelValue":t[2]||(t[2]=t=>e.ruleForm.taskName=t),placeholder:"请输入"},null,8,["modelValue"])])),_:1}),k(d,{label:"门店",prop:"businessUuid"},{default:D((()=>[k(p,{modelValue:e.ruleForm.businessUuid,"onUpdate:modelValue":t[3]||(t[3]=t=>e.ruleForm.businessUuid=t),style:{width:"350px"},placeholder:"请选择",onChange:a.selectBusiness},{default:D((()=>[(x(!0),_(B,null,L(e.popInfo.mechanismList,(e=>(x(),N(c,{label:e.name,key:e.uuid,value:e.uuid},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),k(d,{label:"养护类型",prop:"mteType"},{default:D((()=>[k(p,{modelValue:e.ruleForm.mteType,"onUpdate:modelValue":t[4]||(t[4]=t=>e.ruleForm.mteType=t),style:{width:"350px"},placeholder:"请选择"},{default:D((()=>[(x(!0),_(B,null,L(e.popInfo.curingType,(e=>(x(),N(c,{label:e.label,key:e.value,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),U("div",H,[k(d,{label:"生成周期",prop:"cycle"},{default:D((()=>[k(p,{modelValue:e.ruleForm.cycle,"onUpdate:modelValue":t[5]||(t[5]=t=>e.ruleForm.cycle=t),style:{width:"100px"},placeholder:"请选择",onChange:a.selectCycle},{default:D((()=>[(x(!0),_(B,null,L(e.popInfo.cycleList,(e=>(x(),N(c,{label:e.label,key:e.value,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue","onChange"])])),_:1}),3!==e.ruleForm.cycle?(x(),N(d,{key:0,label:"养护周期",prop:"cycleNum"},{default:D((()=>[k(m,{modelValue:e.ruleForm.cycleNum,"onUpdate:modelValue":t[6]||(t[6]=t=>e.ruleForm.cycleNum=t),placeholder:"请输入",maxlength:"3",style:{width:"140px"}},{suffix:D((()=>[U("div",J,I(e.popInfo.cycType[e.ruleForm.cycle]),1)])),_:1},8,["modelValue"])])),_:1})):S("",!0)]),3==e.ruleForm.cycle?(x(),N(d,{key:0,label:"任务设置",prop:"setTask"},{default:D((()=>[k(y,{modelValue:e.ruleForm.setTask,"onUpdate:modelValue":t[7]||(t[7]=t=>e.ruleForm.setTask=t)},{default:D((()=>[k(f,{label:3},{default:D((()=>[W])),_:1})])),_:1},8,["modelValue"])])),_:1})):S("",!0),k(d,{label:"首次任务时间",prop:"firstTime"},{default:D((()=>[k(b,{data:e.ruleForm,"key-word":"firstTime",config:e.popInfo.basePickerConfig,style:{width:"350px"}},null,8,["data","config"]),2==e.ruleForm.cycle||3==e.ruleForm.cycle||4==e.ruleForm.cycle?(x(),_("div",A," 首次任务时间将影响后续任务的创建时间，请确保开始时间为每月28号之前，否则将影响养护任务的自动生成。 ")):S("",!0)])),_:1}),k(d,{label:"商品类型",prop:"productType"},{default:D((()=>[k(p,{modelValue:e.ruleForm.productType,"onUpdate:modelValue":t[8]||(t[8]=t=>e.ruleForm.productType=t),style:{width:"350px"},placeholder:"请选择",multiple:""},{default:D((()=>[(x(!0),_(B,null,L(e.popInfo.categoryList,(e=>(x(),N(c,{label:e.key,key:e.key,value:e.key},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),k(d,{label:"养护排序条件",prop:"sortCode"},{default:D((()=>[k(p,{modelValue:e.ruleForm.sortCode,"onUpdate:modelValue":t[9]||(t[9]=t=>e.ruleForm.sortCode=t),style:{width:"350px"},placeholder:"请选择"},{default:D((()=>[(x(!0),_(B,null,L(e.popInfo.sortCodeList,(e=>(x(),N(c,{label:e.label,key:e.label,value:e.label},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),k(d,{label:"任务状态",prop:"state"},{default:D((()=>[k(y,{modelValue:e.ruleForm.state,"onUpdate:modelValue":t[10]||(t[10]=t=>e.ruleForm.state=t)},{default:D((()=>[k(f,{label:0},{default:D((()=>[G])),_:1}),k(f,{label:1},{default:D((()=>[K])),_:1})])),_:1},8,["modelValue"])])),_:1}),k(d,{label:"备注",prop:"remark"},{default:D((()=>[k(m,{type:"textarea",maxlength:"100",modelValue:e.ruleForm.remark,"onUpdate:modelValue":t[11]||(t[11]=t=>e.ruleForm.remark=t),placeholder:"请输入不超过100字"},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"])])])),_:1},8,["before-close","title","modelValue"])]),k(h,{"before-close":a.handleStatusClose,title:e.statusTitle,modelValue:e.statusVisibility,"onUpdate:modelValue":t[13]||(t[13]=t=>e.statusVisibility=t),width:"420px"},{footer:D((()=>[U("span",te,[k(s,{onClick:a.statusClear},{default:D((()=>[le])),_:1},8,["onClick"]),k(s,{type:"primary",onClick:a.handleStatusDetermine},{default:D((()=>[ae])),_:1},8,["onClick"])])])),default:D((()=>[U("div",ee,[k(g,{model:e.statusRuleForm,ref:"popStatusForm",rules:e.statusRules,"label-width":"110px"},{default:D((()=>[k(d,{label:"任务开始时间",prop:"firstTime"},{default:D((()=>[k(b,{data:e.statusRuleForm,"key-word":"firstTime",config:e.statusPopInfo.basePickerConfig,style:{width:"260px"}},null,8,["data","config"])])),_:1})])),_:1},8,["model","rules"])])])),_:1},8,["before-close","title","modelValue"])])}],["__scopeId","data-v-e4b233f6"]]);export{re as default};
