var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,r=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,o=(e,t)=>{for(var a in t||(t={}))l.call(t,a)&&r(e,a,t[a]);if(s)for(var a of s(t))i.call(t,a)&&r(e,a,t[a]);return e},u=(e,s)=>t(e,a(s)),n=(e,t)=>{var a={};for(var r in e)l.call(e,r)&&t.indexOf(r)<0&&(a[r]=e[r]);if(null!=e&&s)for(var r of s(e))t.indexOf(r)<0&&i.call(e,r)&&(a[r]=e[r]);return a};import{_ as d}from"./SubmitButton.99d990fd.js";import{_ as m}from"./EditForm.8c35f1a6.js";import{_ as c}from"./BaseTable.36f55649.js";import{_ as b}from"./SelectTable.80e1f2f6.js";import{_ as p}from"./KeyBoard.96ba8d0b.js";import{_ as f}from"./BaseCard.46de0c24.js";import{_ as v}from"./BaseName.1aa32b4b.js";import{u as h}from"./vuex.c868d4e0.js";import{l as y,a as w,b as N,c as O,d as k}from"./index.d94b3f7b.js";import{_ as g}from"./lodash.d7ab6f48.js";import{b as P,_ as j}from"./element-plus.b44d97a8.js";import{b as U}from"./vue-router.91336ba9.js";import{B as x}from"./BaseNotice.93ee8e4e.js";import{a as F}from"./businessRule.60794e55.js";import{j as S,e as I,S as D,B as C,Y as B,G as _,n as A,D as T,t as L,o as q,a5 as R,w as E,a6 as z,c as V,v as $,a9 as H,aa as M}from"./@vue.23a4bd1a.js";import{_ as K}from"./index.ab904951.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";var Z={name:"LossAndOverFlowAdd",components:{BaseCard:f,BaseTable:c,BaseForm:v,BaseNotice:x},setup(){let e=h(),{dict:t,info:a}=e.state.common,s=S({LossAndOverflowRefuseReason:t.find((e=>"lossOverflowReason"===e.key)).data,LossAndOverflowRefuseList:[]});const l=S({baseNameList:["name","specification","unit","manufacturer"],type:"",isSee:null,unitBg:{background:"#F5F7FA",color:"#C0C4CC"},keyBoard:null,ruleForm:null,baseTable:null,tabClose:!1,isEdit:!1,submitNum:0,queryUuid:"",tableData:[],storeList:[],selectArr:[],keys:["code","name","dosageForm","specification","manufacturer"],batchObject:{productUuid:"",batchNum:""},batchKeys:["batchNum","batchNumIn","overallPackNumAndUnit","deleavePackNumAndUnit","specification","manufacturer"],batchHeader:["批号","批次号","整装数量","拆零数量","规格","生产厂家"],batchNumberInObj:{},batchProps:{label:"batchNumIn",value:"batchNumIn"},top:{"margin-top":"5px"},design:{width:"220px",height:"40px"},pot:-1,selectParams:{businessUuid:"",invincible:""},submitForm:{creator:1},formData:{inline:!0,labelWidth:"100px",list:[{label:"门店",key:"businessUuid",type:"SELECT",require:!0,span:4,props:{label:"name",value:"uuid"},list:()=>l.storeList,config:{onChange:e=>{0==l.tableData.length&&(l.oldBusiness=l.submitForm.businessUuid),l.tableData.length>0&&P.confirm("切换当前门店会清空数据!","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{l.tableData=[],l.oldBusiness=l.submitForm.businessUuid})).catch((()=>{l.submitForm.businessUuid&&(l.submitForm.businessUuid=l.oldBusiness)}))}}},{type:"INPUT",placeholder:"请输入,不超过200字",label:"备注",key:"remark",span:9,design:{width:"350px"},config:{"show-word-limit":!0,type:"textarea",maxlength:200,autosize:{minRows:1}}},{label:"损溢单编号",key:"lossOverflowNo",type:"DIV",span:3},{label:"创建人",key:"creator",type:"DIV",span:4},{label:"制单时间",key:"planDate",type:"DIV",span:4}]},columns:[{title:"序号",type:"index",fixed:"left",formConfig:{width:50}},{key:"code",title:"商品编码",fixed:"left",width:80},{title:"商品名称/规格/单位/生产厂家",key:"name",fixed:"left",width:256,formConfig:{"show-overflow-tooltip":!1},render:e=>I(v,{row:e,list:l.baseNameList},null)},{title:"批次",key:"batchNumberIn",require:!0,width:250,render:(e,t,a,s)=>I(b,{class:e[`batchNumberIn_${s}`],keys:l.batchKeys,placeholder:"请输入",design:l.design,disabled:"see"==l.type,head:l.batchHeader,icon:!1,options:l.batchNumberInObj[l.tableData[s].productUuid],"style-enum":{1:{width:"220px"}},props:l.batchProps,top:l.top,config:{modelValue:e.batchNumIn,onChange:t=>{if(t){const a=l.tableData.filter(((e,t)=>t!==s)).some((a=>a.batchNumberIn===t&&a.productUuid===e.productUuid));a?(j.warning("批次不能相同!"),e.batchNumberIn="",e.batchNum="",e.batchNumIn=""):e.batchNumberIn=t;const i=g.find(l.batchNumberInObj[l.tableData[s].productUuid],{batchNumIn:t});e.batchNumber=a?"":i.batchNum,e.overallPackNum=a?"":i.overallPackNum,e.deleavePackNum=a?"":i.deleavePackNum,e.batchNumIn=a?"":i.batchNumIn}},onInput:e=>{m(e)}}},null)},{title:"批号",key:"batchNumber",width:200},{title:"库存数量",key:"overallPackNum",width:100,align:"right",render:e=>I("div",null,[0==e.overallPackNum&&0!=e.deleavePackNum||0==e.overallPackNum&&0==e.deleavePackNum?"0":e.overallPackNum,e.overallPackNum||0==e.overallPackNum&&0!=e.deleavePackNum?e.unit:"",e.deleavePackNum?e.deleavePackNum:"",e.deleavePackNum?e.splitUnit:""])},{title:"整装损溢数量",key:"lossOverflowNumber",require:!0,formConfig:{"show-overflow-tooltip":!1},width:132,header:()=>I("div",{class:"table-title"},[I("i",null,[D("*")]),D("整装损溢数量")]),render:(e,t,a,s)=>e.lossOverflowNumber||"see"!=l.type?I("div",{class:"numberItem"},[I(C("el-input-number"),{class:e[`lossOverflowNumber_${s}`],size:"medium",disabled:"see"==l.type,max:999999.999999,min:-999999.999999,modelValue:e.lossOverflowNumber||void 0,onChange:t=>{r(e,"lossOverflowNumber",t,s),p(e)},placeholder:"请输入"},null),I("i",{class:"companyText",style:"see"==l.type?l.unitBg:""},[e.unit])]):I("div",null,[D("-")])},{title:"拆零损溢数量",key:"lossOverflowNumberSplit",width:132,header:()=>I("div",{class:"table-title"},[I("i",null,[D("*")]),D("拆零损溢数量")]),render:(e,t,a,s)=>!e.isSplit||!e.lossOverflowNumberSplit&&"see"==l.type?I("div",null,[D("-")]):I("div",{class:"numberItem"},[I(C("el-input-number"),{class:e[`lossOverflowNumberSplit_${s}`],size:"medium",disabled:"see"==l.type,max:999999.999999,min:-999999.999999,modelValue:e.lossOverflowNumberSplit||void 0,onChange:t=>{r(e,"lossOverflowNumberSplit",t,s),p(e)},placeholder:"请输入"},null),I("i",{class:"companyText",style:"see"==l.type?l.unitBg:""},[e.splitUnit])])},{title:"损溢原因",key:"lossOverflowReason",width:125,require:!0,header:()=>I("div",{class:"table-title"},[I("i",null,[D("*")]),D("损溢原因")]),render:(e,t,a,i)=>{let o;return I(C("el-select"),{size:"medium",disabled:"see"==l.type,class:e[`lossOverflowReason_${i}`],modelValue:e.lossOverflowReason,placeholder:"请选择",onChange:t=>{r(e,"lossOverflowReason",t)}},"function"==typeof(u=o=s.LossAndOverflowRefuseReason.map((e=>I(C("el-option"),{key:e.key,label:e.key,value:e.key},null))))||"[object Object]"===Object.prototype.toString.call(u)&&!B(u)?o:{default:()=>[o]});var u}},{title:"损溢成本金额",key:"lossOverflowCost",width:125,align:"right",header:()=>_(x,{title:"损溢成本金额",content:"=整装成本进价*整装损溢数量+拆零成本进价*拆零损溢数量"}),render:e=>{let t=(e.overallPackPrice*e.lossOverflowNumber*100||0)+(e.deleavePackPrice*e.lossOverflowNumberSplit*100||0);return t=(t/100).toFixed(2),I("div",null,[t||"0.00"])}},{title:"成本进价",key:"overallPackPrice",width:150,align:"right",render:e=>{let t=e.overallPackPrice;return I("div",null,[parseFloat(t).toFixed(2)||"0.00"])}},{title:"零售价",key:"retailPrice",align:"right",width:150,render:e=>I("div",null,[parseFloat(e.retailPrice).toFixed(2)||"0.00"])},{title:"损溢零售金额",key:"lossOverflowRetail",align:"right",width:125,header:()=>_(x,{title:"损溢零售金额",content:"=损溢整装数量*整装零售价+损溢拆零数量*拆零零售价"}),render:e=>{let t=(e.lossOverflowNumber*e.retailPrice*100||0)+(e.lossOverflowNumberSplit*e.retailPriceSplit*100||0)||0;return t=(t/100).toFixed(2),I("div",null,[parseFloat(t).toFixed(2)||"0.00"])}},{title:"上市许可持有人",key:"holderPermit",width:170,isShowTwo:!0,formConfig:{"show-overflow-tooltip":!1}},{title:"操作",key:"options",width:150,render:(e,t,a,s)=>"see"!=l.type?I(C("el-button"),{type:"text",class:"delete",onClick:()=>{l.tableData.splice(s,1),l.pot=s}},{default:()=>[D("删除")]}):I("div",null,null)}]}),i=U(),r=(e,t,a,s)=>{e[t]=0===a?a.toFixed(6):a,e[t]=a;let l=(1e6*e.lossOverflowNumber*e.retailPrice*1e6||0)+(1e6*e.lossOverflowNumberSplit*e.retailPriceSplit*1e6||0)||0;l=(l/1e12).toFixed(2);let i=(1e6*e.overallPackPrice*e.lossOverflowNumber*1e6||0)+(1e6*e.deleavePackPrice*e.lossOverflowNumberSplit*1e6||0);i=(i/1e12).toFixed(2),e.lossOverflowRetail=l,e.lossOverflowCost=i},d=async()=>{O(u(o({},l.batchObject),{filterZeroStock:0})).then((e=>{e.map((e=>{e.overallPackNumAndUnit=e.overallPackNum+e.unit,e.isSplit?e.deleavePackNumAndUnit=e.deleavePackNum+e.splitUnit:e.deleavePackNumAndUnit="-"})),l.batchNumberInObj[l.batchObject.productUuid]=e}))},m=e=>{l.batchObject.batchNum=e.data,l.batchObject.businessUuid=l.submitForm.businessUuid,d()},c=async()=>{if(i.query.uuid){l.queryUuid=i.query.uuid;let e=await k(i.query.uuid),{lossOverflowOrderDetailInfoList:t,lossOverflowUuid:a,business:s}=e,r=n(e,["lossOverflowOrderDetailInfoList","lossOverflowUuid","business"]);l.tableData=t,l.submitForm=r,i.query.showEdit?l.disabled=!0:l.disabled=!1,l.tableData.map((e=>{e.batchNumIn=e.batchNumberIn}))}else{l.queryUuid=void 0,l.tableData=[];let e=l.submitForm,{businessUuid:t}=e;n(e,["businessUuid"]);l.submitForm={businessUuid:t}}l.submitForm.creator=a.userName},p=e=>{e.lossOverflowNumber<0&&Math.abs(e.lossOverflowNumber)>e.overallPackNum&&P.alert("损溢数量不能大于现有库存数量",{confirmButtonText:"我知道了",callback:t=>{e.lossOverflowNumber=void 0}}),e.lossOverflowNumberSplit<0&&Math.abs(e.lossOverflowNumberSplit)>e.deleavePackNum&&P.alert("损溢数量不能大于现有库存数量",{confirmButtonText:"我知道了",callback:t=>{e.lossOverflowNumberSplit=void 0}});let{array:t,index:a}=l.keyBoard;t[l.keyBoard.index].focus()};A((()=>{l.isSee=i.query.isSee,(async()=>{l.storeList=await e.dispatch("common/mechanism"),F(l.submitForm,l.storeList),JSON.parse(sessionStorage.getItem("dict"))})()})),T((()=>{l.isEdit=i.query.uuid,l.type=i.query.type,l.queryUuid!==i.query.uuid&&c()}));const f=()=>{P.confirm("请选择门店后,再进行操作","提示",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then((()=>{l.isFlag=!0})).catch((()=>{l.isFlag=!0}))};return u(o(o({},L(l)),L(s)),{submitAdd:async e=>{if(!l.submitForm.businessUuid)return void f();let t=!0,{ruleForm:a,baseTable:s}=l;if(t=a.handleClick(e),!l.tableData.length)return j.warning({message:"请添加商品信息",type:"warning"}),!1;if(l.tableData.length&&(t=s.verification()),!t)return!1;if(l.tableData.forEach(((e,a)=>{!e.isSplit||""!==e.lossOverflowNumberSplit&&null!==e.lossOverflowNumberSplit&&void 0!==e.lossOverflowNumberSplit?e[`lossOverflowNumberSplit_${a}`]="":(e[`lossOverflowNumberSplit_${a}`]="error",t=!1)})),!t)return!1;let r=[];if(l.tableData.forEach(((e,a)=>{e.isSplit?0==e.lossOverflowNumber&&0==e.lossOverflowNumberSplit&&(r.push(e.name),t=!1):0==e.lossOverflowNumber&&(r.push(e.name),t=!1)})),r.length>0){let e="";for(let t=0;t<r.length;t++)e+=r[t]+",";j.error(`${e}整装数量和拆零数量不可同时为0！`)}if(!t)return!1;let o=l.submitForm;o.lossOverflowOrderDetailInfoList=l.tableData;let u=l.storeList.find((e=>e.uuid==l.submitForm.businessUuid));u=u.name,o.business=u,l.isEdit?(o.lossOverflowUuid=i.query.uuid,0==l.submitNum&&y(o).then((e=>{l.tabClose=!0,l.submitNum+=1,setTimeout((()=>{l.submitNum=0}),2e3)}))):0==l.submitNum&&w(o).then((e=>{l.submitNum+=1,l.tabClose=!0,setTimeout((()=>{l.submitNum=0}),2e3)}))},drugChange:()=>{},handleInput:async e=>{if(!l.submitForm.businessUuid)return void f();let{selectParams:t}=l;t.invincible=e,t.businessUuid=l.submitForm.businessUuid;const a=(await N(u(o({},t),{filterZeroStock:0}))).map((e=>{let t=e.info;return t.name=e.info.productName,t.productUuid=e.productUuid,t.drugUuid=e.productUuid,t.businessUuid=e.businessUuid,t.onlyUuid=e.businessUuid+e.productUuid,t.lossOverflowReason="",t.overallPackPrice=e.overallPackPrice,t.deleavePackPrice=e.deleavePackPrice,t.conversionRatio=e.info.conversionRatio,t.retailPriceSplit=e.retailPriceSplit,t}));l.selectArr=a},handleChange:e=>{l.tableData.push(g.cloneDeep(e)),l.pot=l.tableData.length-1,l.batchObject.productUuid=e.productUuid,l.batchObject.businessUuid=l.submitForm.businessUuid,l.selectArr=[],d()},batchHandleInput:m,getBatchNumInStockList:d,getDetail:c,clearMsg:()=>{l.selectArr=[]},submitTips:f})}};const G={class:"LossAndOverFlowAdd",id:"tab"},J=(e=>(H("data-v-00bccc96"),e=e(),M(),e))((()=>z("span",{style:{"font-size":"16px","font-weight":"600"}}," 损溢管理详情 ",-1))),W=D(" 提交审核 "),Y={class:"main"},Q={class:"top-content"};var X=K(Z,[["render",function(e,t,a,s,l,i){const r=d,o=m,u=c,n=b,v=p,h=f;return q(),R("div",G,[I(h,{route:{path:"/storage/loss-and-overflow"},close:e.tabClose,isEdit:e.isSee},{header:E((()=>[J,z("div",null,["see"!=e.type?(q(),V(r,{key:0,class:"btn",onClick:t[0]||(t[0]=e=>s.submitAdd(!0)),config:{size:"small"}},{default:E((()=>[W])),_:1})):$("",!0)])])),default:E((()=>[I(v,{ref:"keyBoard",data:e.tableData,down:[".main .select-table .el-table__body-wrapper  .el-table__row"],range:[0,1,2,3,4],pot:e.pot,first:".main .select-input"},{default:E((()=>[z("div",Y,[z("div",Q,[I(o,{disabled:"see"==e.type,"form-data":e.formData,"onUpdate:form-data":t[1]||(t[1]=t=>e.formData=t),"submit-form":e.submitForm,"onUpdate:submit-form":t[2]||(t[2]=t=>e.submitForm=t),ref:"ruleForm",style:{"min-width":"1280px"}},null,8,["disabled","form-data","submit-form"])]),I(u,{optionShow:!1,"fixed-head":!1,class:"select-table","table-data":e.tableData,columns:e.columns,ref:"baseTable","class-id":"tab","reduce-num":210},null,8,["table-data","columns"]),I(n,{disabled:"see"==e.type,class:"select-input",placeholder:"请输入商品编码/助记码/商品名称/条码",onOnInput:s.handleInput,onOnChange:s.handleChange,head:e.batchHeader,onClear:s.clearMsg,options:e.selectArr,"onUpdate:options":t[3]||(t[3]=t=>e.selectArr=t),keys:e.keys,optionsClass:"",props:{label:"name",value:"onlyUuid"}},null,8,["disabled","onOnInput","onOnChange","head","onClear","options","keys"])])])),_:1},8,["data","down","pot"])])),_:1},8,["close","isEdit"])])}],["__scopeId","data-v-00bccc96"]]);export{X as default};
