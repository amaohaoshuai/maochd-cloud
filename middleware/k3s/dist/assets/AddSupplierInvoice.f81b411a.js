var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,n=(t,i,o)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o,s=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&n(e,i,t[i]);if(o)for(var i of o(t))l.call(t,i)&&n(e,i,t[i]);return e};import{_ as r}from"./SubmitButton.99d990fd.js";import{_ as d}from"./EditForm.8c35f1a6.js";import{_ as u}from"./BaseTable.36f55649.js";import{_ as m}from"./SelectTable.80e1f2f6.js";import{_ as p}from"./KeyBoard.96ba8d0b.js";import{_ as c}from"./BaseStencil.46c3d678.js";import{_ as f}from"./BaseCard.46de0c24.js";import{_ as b}from"./BaseName.1aa32b4b.js";import{b as h}from"./vue-router.91336ba9.js";import{u as g}from"./vuex.c868d4e0.js";import{d as y}from"./BatchNumber.b846d4bb.js";import{_ as v}from"./lodash.d7ab6f48.js";import{_ as w}from"./element-plus.b44d97a8.js";import{d as S}from"./index.6efc7880.js";import{_ as U}from"./index.ab904951.js";import{g as j,b as k,c as x,d as N}from"./SupplierInvoice.6bf9f95c.js";import{a as C}from"./businessRule.60794e55.js";import{g as I,j as F,e as T,S as A,B as _,n as B,D,t as L,L as P,o as O,a5 as V,w as z,a6 as q,z as E,v as M,J as H,a9 as $,aa as K}from"./@vue.23a4bd1a.js";import"./TempHtml.vue_vue&type=script&lang.67ba229f.js";import"./sortablejs.621e50ab.js";import"./element-resize-detector.5b0b5621.js";import"./batch-processor.94093b2a.js";import"./BaseForm.bc55ad6b.js";import"./public.9c1d8f39.js";/* empty css                                                             */import"./axios.7b768d2b.js";import"./dayjs.bad04745.js";import"./resize-observer-polyfill.d4249adb.js";import"./normalize-wheel.1d574cd1.js";import"./mitt.32ebca9f.js";import"./async-validator.1fa0d626.js";import"./@popperjs.192dcd39.js";import"./vue.6d04e91d.js";import"./echarts.e8cef18b.js";import"./tslib.34a40861.js";import"./zrender.5bef55a0.js";import"./vue3-print-nb.eccf419a.js";import"./nprogress.8b4927f9.js";import"./default-passive-events.74004992.js";var W={name:"AddSupplierInvoice",components:{SelectTable:m},setup(e){const o=I(null),a=I([]);let l=h(),n=g(),r=F({infos:[],isInputSelect:!1,batchObject:{productUuid:"",batchNum:""},businessMechanismList:[],supplierList:[],selectArr:[],invoiceType:[{value:0,label:"增值税普通发票"},{value:1,label:"增值税专用发票"}],keys:["code","name","dosageForm","specification","manufacturer","taxPaid","orderNo"],batchKeys:["batchNum","batchNumIn","overallPackNum","deleavePackNum"],batchHeader:["商品编码","商品名称","剂型","规格","生产厂家","含税进价","业务单编号"],batchNumberIn:{},batchProps:{label:"batchNumIn",value:"batchNumIn"},top:{"margin-top":"5px"},design:{width:"220px",height:"36px"},barchWidth:{width:"160px"}}),d=F({multipleList:[],formConfig:{rowKey:e=>e.uuid},submitForm:{"page.currentPage":1,"page.pageSize":10},tableData:[],loading:!1,dialogVisible:!1,deepSearchTable:{form:{inline:!0,labelWidth:"100px",list:[{label:"业务单编号",type:"INPUT",key:"orderNo"},{label:"制单时间",type:"LINKAGETIME",keys:["startTime","endTime"],design:{width:"220px"},key:"createTime"}]},tableConfig:{columns:[{type:"selection",formConfig:{reserveSelection:!0}},{type:"index",title:"序号",formConfig:{width:50},fixed:"left"},{title:"业务单编号",key:"orderNo",width:124},{title:"数量",key:"num",align:"right"},{title:"应结算金额",key:"shouldBeSettled",width:120,align:"right"},{title:"未结算金额",key:"noSettled",width:120,align:"right"},{title:"采购员",key:"purchaseUser"},{title:"制单时间",key:"planDate",width:180}]}},title:"请选择业务单据",index:0,editForm:null,editForm1:null,baseTable:null,keyBoard:null,close:!1,go:{path:"/finance-manage/supplier-invoice"},config:{size:"medium"},text:"新增",pot:-1,query:{},formInfo:{labelWidth:"90px",span:8,list:[{label:"结算单编号",type:"DIV",key:"settleNo"},{label:"创建人",type:"DIV",key:"createUser"},{label:"制单时间",type:"DIV",key:"planDate"},{label:"供应商名称",type:"SELECT",key:"supplierUuid",props:{label:"supplierName",value:"uuid"},require:!0,config:{filterable:!0,remote:!0,remoteMethod:e=>{U(e)},onChange(e){P(e)}},list:()=>r.supplierList},{label:"门店",type:"SELECT",key:"businessUuid",require:!0,props:{label:"name",value:"uuid"},config:{onChange(e){O(e)}},list:()=>r.businessMechanismList},{label:"发票号码",type:"INPUT",key:"invoiceNo",rules:[{pattern:/^[0-9]\d*$/,trigger:"blur"}]},{label:"发票代码",type:"INPUT",key:"invoiceCode"},{label:"发票金额",type:"INPUT",key:"invoiceAmount",require:!0,config:{class:"invoice-amount-input",maxlength:9,onChange:e=>{z(e)}},suffix:{tempHtml:()=>T("div",{style:"margin-right: 10px;font-size: 14px;color: #313233;"},[A("元")])}},{label:"发票类型",type:"RADIO",key:"invoiceType",require:!0,list:()=>r.invoiceType},{label:"备注",type:"INPUT",key:"remark",config:{type:"textarea",maxlength:200,"show-word-limit":!0,placeholder:"请输入，不超过200字",class:"batch-number-remark"}}]},info:{createUser:n.state.common.info.userName,invoiceType:1,settleAmount:0,noSettled:0,shouldBeSettled:0},columns:[{title:"序号",type:"index",formConfig:{width:50}},{title:"商品编码",key:"code",formConfig:{"show-overflow-tooltip":!1,"min-width":150}},{title:"商品名称/规格/单位/生产厂家",key:"name",formConfig:{"show-overflow-tooltip":!1,"min-width":180},render:e=>T(b,{row:e},null)},{title:"数量",key:"num",formConfig:{"show-overflow-tooltip":!1,"min-width":150},align:"right"},{title:"含税进价",key:"taxPaid",formConfig:{"show-overflow-tooltip":!1,"min-width":150},align:"right"},{title:"应结算金额",key:"shouldBeSettled",formConfig:{"show-overflow-tooltip":!1,"min-width":150},align:"right"},{title:"未结算金额",key:"noSettled",formConfig:{"show-overflow-tooltip":!1,"min-width":150},align:"right"},{title:"本次结算金额",key:"settleAmount",align:"right",formConfig:{"show-overflow-tooltip":!1,"min-width":150},require:!0,render:(e,t,i,o)=>T(_("el-input-number"),{style:"width:100px;text-align: right;",class:e[`settleAmount_${o}`],size:"medium",precision:0,max:e.noSettled>0?e.noSettled:-.01,min:e.noSettled>0?-.01:e.noSettled,modelValue:e.settleAmount||void 0,onChange:t=>{m(e,"settleAmount",t,o)},placeholder:"请输入"},null)},{title:"采购员",key:"purchaseUser",formConfig:{"show-overflow-tooltip":!1,"min-width":150}},{title:"入库/退货时间",key:"operateTime",width:110},{title:"随货同行单",key:"peer",width:110},{title:"操作",key:"options",fixed:"right",width:150,render:(e,t,i,o)=>T(_("el-button"),{type:"text",class:"delete",onClick:()=>{d.data.splice(o,1),d.pot=o,u()}},{default:()=>[A("删除")]})}],data:[],formData:[{labelWidth:"90px",span:12,list:[{label:"业务单编号",type:"INPUT",key:"settleNo"},{label:"制单时间",type:"DIV",key:"createUser"}]}]});const u=e=>{let t=0,i=0,o=0;d.data.map((e=>{t+=e.settleAmount,i+=e.shouldBeSettled,o+=e.noSettled})),d.info.settleAmount=t.toFixed(2),d.info.shouldBeSettled=i.toFixed(2),d.info.noSettled=o.toFixed(2)},m=(e,t,i,o)=>{e[t]=i,e[t]&&u()},p=async()=>{d.submitForm.businessUuid=d.info.mechanismUuid,d.submitForm.supplierUuid=d.info.supplierUuid;const e=await x(d.submitForm);d.tableData=e.list,d.submitForm.pageNumber=e.currentPage,d.submitForm.total=e.totalElements,0!=d.tableData.length?d.dialogVisible=!0:w.warning("暂无业务单据")},c=async e=>{const t=await y(e);d.info=t,d.data=t.modifyJson,d.data.map((e=>{e.name=e.productName}))};B((async()=>{U(),f()})),D((async()=>{let{query:e}=l;r.infos=await n.dispatch("common/mechanism"),1===r.infos.length&&(d.info.mechanismUuid=r.infos[0].uuid),f(),d.text=e.uuid?"编辑":"新增",d.query.uuid!==e.uuid&&(e.uuid?c(e.uuid):(d.info={},d.data=[]),d.query=v.cloneDeep(e))}));const f=async()=>{r.businessMechanismList=r.infos,C(d.info,r.infos),d.submitForm.businessUuid=r.infos[0].uuid},U=async(e="")=>{const t=await S({queryStr:e});r.supplierList=t},P=e=>{d.info.supplierUuid=e,d.data=[];let t=v.find(r.supplierList,{uuid:e});d.info.supplierName=t.supplierName},O=e=>{d.info.mechanismUuid=e;let t=v.find(r.businessMechanismList,{uuid:e});d.info.business=t.name},V=e=>!(!/^\d+(\.\d+)?$/.test(e)&&!/^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$/.test(e)),z=e=>{if(e)return V(e)?void(parseFloat(e)<-999999.99?d.info.invoiceAmount=-999999.99:parseFloat(e)>999999.99?d.info.invoiceAmount=999999.99:d.info.invoiceAmount=parseFloat(e).toFixed(6)):(w.warning("请输入数字"),void(d.info.invoiceAmount=""))};return q=s(s({popList:a,handleClose:e=>{e()},baseForm:o,clear:()=>{d.dialogVisible=!1},isNumber:V},L(d)),L(r)),t(q,i({getDetail:c,handleInput:async e=>{if(!e)return;let t={fuzzyValue:e,businessUuid:d.info.mechanismUuid,supplierUuid:d.info.supplierUuid};const i=(await j(t)).map((e=>{let t=e;return t.name=e.productName,t.productUuid=e.productUuid,t.drugUuid=e.productUuid,t.taxPaid=e.taxPaid,t.onlyUuid=e.uuid+e.productUuid,t.orderNo=e.orderNo,t.uuid=e.uuid,t}));r.selectArr=i},handleChange:e=>{d.data.push(v.cloneDeep(e)),a.value=d.data,d.pot=d.data.length-1,r.batchObject.productUuid=e.productUuid,r.isInputSelect=!0,u(),r.selectArr=[]},handleSubmit:async e=>{let{info:t,data:i,editForm:o,editForm1:a,baseTable:n}=d,s=!0;return s=o.handleClick(e),!!s&&(i.length?(i.length&&(s=n.verification()),!!s&&(await k({detail:i,businessUuid:d.info.mechanismUuid,invoiceAmount:d.info.invoiceAmount,invoiceNo:d.info.invoiceNo,invoiceType:d.info.invoiceType,supplierUuid:d.info.supplierUuid,abandonedTime:d.info.abandonedTime,abandonedUser:d.info.abandonedUser,business:d.info.business,createUser:d.info.createUser,invoiceCode:d.info.invoiceCode,noSettled:d.info.noSettled,planDate:d.info.planDate,remark:d.info.remark,settleAmount:d.info.settleAmount,settleNo:d.info.settleNo,shouldBeSettled:d.info.shouldBeSettled,supplierName:d.info.supplierName,uuid:l.query.uuid}),void(d.close=!0))):(w.warning({message:"请添加商品信息",type:"warning"}),!1))},batchHandleInput:async e=>{r.batchObject.batchNum=e},getSupplierListData:U,businessMechanismListData:f,selectSupplier:P,selectMechanism:O,countMoney:u,selectBusinessBill:()=>{d.multipleList=[],d.submitForm.orderNo="",d.submitForm.startTime="",d.submitForm.endTime="",d.submitForm["page.currentPage"]=1,d.submitForm["page.pageSize"]=10,p()},selectInvoiceAmount:z,selectInvoiceSettleData:p,submitFormBtn:async()=>{let e=[],t=[],i=[],o=[],l=[],n=!1;if(0===d.multipleList.length)return void w.warning("请选择业务编号！");d.multipleList.map((t=>{e.push(t.orderNo)}));let s=e;const m=await N(s);m.map((e=>{e.name=e.productName,e.settleAmount=e.settleAmount?e.settleAmount:e.noSettled,e.drugUuid=e.productUuid,o.push(e.uuid)})),d.data.map((e=>{l.push(e.uuid)})),t=m,i=d.data;let p={};const c=i.concat(t).reduce(((e,t)=>(!p[t.uuid]&&(p[t.uuid]=e.push(t)),e)),[]);n=!r.isInputSelect&&l.toString().includes(o.toString()),r.isInputSelect=!1,l.sort().toString()==o.sort().toString()||n||v.intersection(l,o).length===o.length?w.warning("该商品已存在，不可重复结算"):(d.data=c,a.value=c,u(),d.dialogVisible=!1)},multipleSelection:e=>{d.multipleList=e}}));var q}};const J={style:{height:"100%"},id:"tab"},R=(e=>($("data-v-11aee12a"),e=e(),K(),e))((()=>q("div",{class:"title"},"供应商发票结算单详情",-1))),G=A(" 完成 "),Q={class:"top-content"},X={class:"main"},Y={class:"scope-line"},Z=A(" 选择业务单据 "),ee={key:0},te={style:{"margin-right":"60px"}},ie={style:{"margin-right":"60px"}},oe={style:{height:"600px"}},ae={style:{height:"30px",display:"flex","align-items":"center",width:"100%","justify-content":"flex-end"}},le={class:"dialog-footer"},ne=A(" 取 消 "),se=A(" 确 定 ");var re=U(W,[["render",function(e,t,i,o,a,l){const n=r,s=d,b=_("el-button"),h=u,g=m,y=p,v=_("el-scrollbar"),w=c,S=_("el-dialog"),U=f,j=P("loading");return O(),V("div",J,[T(U,{close:e.close,route:e.go},{header:z((()=>[R,q("div",null,[T(n,{config:e.config,onClick:t[0]||(t[0]=e=>o.handleSubmit(!0)),size:"small"},{default:z((()=>[G])),_:1},8,["config"])])])),top:z((()=>[q("div",Q,[T(s,{"form-data":e.formInfo,"onUpdate:form-data":t[1]||(t[1]=t=>e.formInfo=t),"submit-form":e.info,"onUpdate:submit-form":t[2]||(t[2]=t=>e.info=t),ref:"editForm"},null,8,["form-data","submit-form"])]),T(v,null,{default:z((()=>[T(y,{ref:"keyBoard",data:e.data,down:[".main .select-table .el-table__body-wrapper .el-table__row"],range:[0],first:".main .select-input",pot:e.pot},{default:z((()=>[q("div",X,[T(h,{class:"select-table",columns:e.columns,"table-data":e.data,"fixed-head":!1,ref:"baseTable","class-id":"tab","reduce-num":380},{buttons:z((t=>[q("div",Y,[T(b,{type:"primary",size:"small",onClick:o.selectBusinessBill,disabled:!e.info.supplierUuid||!e.info.mechanismUuid},{default:z((()=>[Z])),_:1},8,["onClick","disabled"]),e.data.length>0?(O(),V("div",ee,[q("span",te," 应结算金额合计："+E(e.info.shouldBeSettled)+"元 ",1),q("span",ie," 未结算金额合计："+E(e.info.noSettled)+"元 ",1),q("span",null,"本次结算金额合计："+E(e.info.settleAmount)+"元",1)])):M("",!0)])])),_:1},8,["columns","table-data"]),T(g,{class:"select-input",keys:e.keys,options:e.selectArr,"onUpdate:options":t[3]||(t[3]=t=>e.selectArr=t),placeholder:"请输入商品编码/助记码/商品名称/条码",onOnInput:o.handleInput,onOnChange:o.handleChange,head:e.batchHeader,"table-data":e.data,config:{disabled:!e.info.supplierUuid||!e.info.mechanismUuid},props:{label:"name",value:"onlyUuid"}},null,8,["keys","options","onOnInput","onOnChange","head","table-data","config"])])])),_:1},8,["data","down","pot"])])),_:1})])),default:z((()=>[T(S,{"before-close":o.handleClose,title:e.title,modelValue:e.dialogVisible,"onUpdate:modelValue":t[7]||(t[7]=t=>e.dialogVisible=t),width:"1200px"},{footer:z((()=>[q("span",le,[T(b,{onClick:t[5]||(t[5]=e=>o.clear()),style:{"margin-right":"20px"}},{default:z((()=>[ne])),_:1}),T(b,{type:"primary",loading:e.loading,onClick:t[6]||(t[6]=e=>o.submitFormBtn())},{default:z((()=>[se])),_:1},8,["loading"])])])),default:z((()=>[q("div",oe,[H(T(w,{"form-data":e.deepSearchTable.form,"submit-form":e.submitForm,"onUpdate:submit-form":t[4]||(t[4]=t=>e.submitForm=t),class:"base-stencil","table-data":e.tableData,columns:e.deepSearchTable.tableConfig.columns,pagination:e.submitForm,draggable:!1,options:!0,"option-show":!1,multipleSelection:o.multipleSelection,formConfig:e.formConfig,select:o.selectInvoiceSettleData,ref:"baseForm",btnIndex:1},{buttons:z((t=>[q("div",ae,E(e.multipleList.length?`已选业务单数量：${e.multipleList.length}`:""),1)])),_:1},8,["form-data","submit-form","table-data","columns","pagination","multipleSelection","formConfig","select"]),[[j,e.loading]])])])),_:1},8,["before-close","title","modelValue"])])),_:1},8,["close","route"])])}],["__scopeId","data-v-11aee12a"]]);export{re as default};
